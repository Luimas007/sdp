<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post Lost/Found Item | BUP Lost & Found</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8fafc;
      }

      .nav-glass {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }

      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .shine-effect {
        position: relative;
        overflow: hidden;
      }

      .shine-effect::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to bottom right,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0) 45%,
          rgba(255, 255, 255, 0.3) 48%,
          rgba(255, 255, 255, 0.3) 52%,
          rgba(255, 255, 255, 0) 55%,
          rgba(255, 255, 255, 0) 100%
        );
        transform: rotate(30deg);
        animation: shine 3s infinite linear;
      }

      @keyframes shine {
        0% {
          transform: translateX(-100%) rotate(30deg);
        }
        100% {
          transform: translateX(100%) rotate(30deg);
        }
      }
    </style>
  </head>
  <body class="antialiased text-slate-800">
    <!-- Navigation Bar -->
    <nav class="nav-glass fixed w-full z-50">
      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <a href="home.html" class="flex items-center space-x-3">
          <div class="shine-effect relative rounded-lg">
            <div
              class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-2 rounded-lg"
            >
              <i class="fas fa-search-location text-white text-xl"></i>
            </div>
          </div>
          <h1
            class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-indigo-400 bg-clip-text text-transparent"
          >
            BUP <span class="font-light">Lost & Found</span>
          </h1>
        </a>
        <div class="flex items-center space-x-4">
          <a
            href="profile.html"
            class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-indigo-50 transition"
          >
            <div class="relative">
              <img
                id="profileImage"
                src="https://via.placeholder.com/40"
                alt="Profile"
                class="w-8 h-8 rounded-full border-2 border-white shadow-md object-cover"
              />
              <div
                class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-white"
              ></div>
            </div>
            <span id="userName" class="font-medium text-slate-700">User</span>
          </a>
          <button
            id="logoutBtn"
            class="flex items-center px-3 py-2 text-slate-700 hover:text-red-600 transition"
          >
            <i class="fas fa-sign-out-alt mr-2"></i>
            <span class="font-medium">Logout</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-24 pb-12">
      <div class="max-w-4xl mx-auto">
        <div
          class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-slate-100"
        >
          <h2 class="text-2xl font-bold text-slate-800 mb-2 flex items-center">
            <span class="w-1 h-6 bg-indigo-600 rounded-full mr-3"></span>
            Post New Item
          </h2>
          <p class="text-slate-600 mb-6">
            Fill out the form below to post a lost or found item
          </p>

          <form id="itemForm" enctype="multipart/form-data">
            <input type="hidden" id="itemId" value="" />

            <!-- Item Type -->
            <div class="mb-6">
              <label class="block text-slate-700 font-medium mb-2"
                >Item Type</label
              >
              <div class="flex space-x-4">
                <label class="flex items-center">
                  <input
                    type="radio"
                    name="type"
                    value="lost"
                    class="form-radio h-5 w-5 text-indigo-600"
                    checked
                  />
                  <span class="ml-2 text-slate-700">Lost Item</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="radio"
                    name="type"
                    value="found"
                    class="form-radio h-5 w-5 text-indigo-600"
                  />
                  <span class="ml-2 text-slate-700">Found Item</span>
                </label>
              </div>
            </div>

            <!-- Item Title -->
            <div class="mb-6">
              <label for="title" class="block text-slate-700 font-medium mb-2"
                >Item Title</label
              >
              <input
                type="text"
                id="title"
                name="title"
                required
                class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                placeholder="e.g. Black Wallet, iPhone 12, etc."
              />
            </div>

            <!-- Description -->
            <div class="mb-6">
              <label
                for="description"
                class="block text-slate-700 font-medium mb-2"
                >Description</label
              >
              <textarea
                id="description"
                name="description"
                rows="3"
                required
                class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                placeholder="Provide detailed description of the item"
              ></textarea>
            </div>

            <!-- Location -->
            <div class="mb-6">
              <label
                for="location"
                class="block text-slate-700 font-medium mb-2"
                >Location</label
              >
              <input
                type="text"
                id="location"
                name="location"
                required
                class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                placeholder="Where did you lose/find this item?"
              />
            </div>

            <!-- Image Upload -->
            <div class="mb-6">
              <label class="block text-slate-700 font-medium mb-2"
                >Item Image</label
              >
              <div class="flex items-center justify-center w-full">
                <label
                  for="image"
                  class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition"
                >
                  <div
                    class="flex flex-col items-center justify-center pt-5 pb-6"
                  >
                    <i
                      class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"
                    ></i>
                    <p class="mb-2 text-sm text-slate-500">
                      <span class="font-semibold">Click to upload</span> or drag
                      and drop
                    </p>
                    <p class="text-xs text-slate-500">PNG, JPG (MAX. 5MB)</p>
                  </div>
                  <input
                    id="image"
                    name="image"
                    type="file"
                    class="hidden"
                    accept="image/*"
                  />
                </label>
              </div>
              <div id="imagePreview" class="mt-3 hidden">
                <img
                  id="previewImage"
                  src="#"
                  alt="Preview"
                  class="max-h-40 rounded-lg border border-slate-200"
                />
                <button
                  type="button"
                  id="removeImage"
                  class="mt-2 text-red-600 text-sm font-medium hover:text-red-800 transition"
                >
                  <i class="fas fa-trash mr-1"></i> Remove Image
                </button>
              </div>
            </div>

            <!-- Validity Questions -->
            <div class="mb-6">
              <div class="flex justify-between items-center mb-2">
                <label class="block text-slate-700 font-medium"
                  >Verification Questions</label
                >
                <span class="text-sm text-slate-500"
                  >At least 1 required (max 10)</span
                >
              </div>
              <p class="text-sm text-slate-500 mb-4">
                These questions will be used to verify the claimant's identity.
                For found items, ask questions only the real owner would know.
              </p>

              <div id="questionsContainer">
                <!-- Questions will be added here dynamically -->
                <div
                  class="question-group mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200"
                >
                  <div class="flex justify-between items-center mb-2">
                    <label class="text-slate-700 font-medium"
                      >Question #1</label
                    >
                    <button
                      type="button"
                      class="remove-question text-red-600 text-sm font-medium hover:text-red-800 transition"
                    >
                      <i class="fas fa-trash mr-1"></i> Remove
                    </button>
                  </div>
                  <input
                    type="text"
                    name="questions[0][question]"
                    required
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition mb-2"
                    placeholder="Enter verification question"
                  />
                  <input
                    type="text"
                    name="questions[0][answer]"
                    required
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                    placeholder="Enter expected answer (only visible to you)"
                  />
                </div>
              </div>

              <button
                type="button"
                id="addQuestionBtn"
                class="mt-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition flex items-center"
              >
                <i class="fas fa-plus mr-2"></i> Add Another Question
              </button>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3">
              <button
                type="button"
                id="cancelBtn"
                class="px-6 py-3 border border-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-100 transition"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="submitBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition"
              >
                Post Item
              </button>
            </div>
          </form>
        </div>

        <!-- Success Message (Hidden by default) -->
        <div
          id="successMessage"
          class="bg-white rounded-xl shadow-sm p-6 border border-slate-100 hidden"
        >
          <div class="text-center">
            <div
              class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"
            >
              <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-800 mb-2">
              Item Posted Successfully!
            </h3>
            <p class="text-slate-600 mb-6">
              Your item has been posted to the bulletin.
            </p>
            <div class="flex justify-center space-x-3">
              <a
                href="home.html"
                class="px-6 py-3 border border-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-100 transition"
              >
                Back to Home
              </a>
              <button
                type="button"
                id="editItemBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition"
              >
                Edit This Item
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-8">
      <div class="container mx-auto px-4 text-center">
        <p class="mb-2">
          Bangladesh University of Professionals (BUP) Lost & Found System
        </p>
        <p class="text-gray-400 text-sm">Â© 2023 All Rights Reserved</p>
      </div>
    </footer>

    <!-- Script -->
    <script>
      // DOM Elements
      const itemForm = document.getElementById("itemForm");
      const questionsContainer = document.getElementById("questionsContainer");
      const addQuestionBtn = document.getElementById("addQuestionBtn");
      const submitBtn = document.getElementById("submitBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const successMessage = document.getElementById("successMessage");
      const editItemBtn = document.getElementById("editItemBtn");
      const imageInput = document.getElementById("image");
      const imagePreview = document.getElementById("imagePreview");
      const previewImage = document.getElementById("previewImage");
      const removeImage = document.getElementById("removeImage");
      const profileImage = document.getElementById("profileImage");
      const userName = document.getElementById("userName");
      const logoutBtn = document.getElementById("logoutBtn");

      // Global variables
      let currentUser = null;
      let questionCount = 1;
      let isEditMode = false;
      let currentItemId = null;

      // Initialize the page
      document.addEventListener("DOMContentLoaded", async () => {
        // Check authentication
        await checkAuth();

        // Load user data
        await loadUserData();

        // Check if we're editing an existing item
        checkEditMode();

        // Set up event listeners
        setupEventListeners();
      });

      // Check authentication
      async function checkAuth() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
      }

      // Load user data
      async function loadUserData() {
        try {
          const response = await fetch("/api/users/me", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to fetch user data");
          }

          const data = await response.json();
          currentUser = data.user;

          // Update UI with user data
          if (data.user.profileImage) {
            profileImage.src = data.user.profileImage.startsWith("/uploads/")
              ? data.user.profileImage
              : `/uploads/${data.user.profileImage}`;
          }
          userName.textContent = `${data.user.firstName} ${data.user.lastName}`;
        } catch (error) {
          console.error("Error loading user data:", error);
          window.location.href = "login.html";
        }
      }

      // Check if we're in edit mode (URL has item ID)
      function checkEditMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get("id");

        if (itemId) {
          isEditMode = true;
          currentItemId = itemId;
          loadItemForEdit(itemId);
        }
      }

      // Load item data for editing
      async function loadItemForEdit(itemId) {
        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';

          const response = await fetch(`/api/items/${itemId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to load item");
          }

          const data = await response.json();
          populateForm(data.item);
        } catch (error) {
          console.error("Error loading item:", error);
          alert("Failed to load item. Please try again.");
          window.location.href = "home.html";
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = isEditMode ? "Update Item" : "Post Item";
        }
      }

      // Populate form with item data
      function populateForm(item) {
        document.getElementById("itemId").value = item._id;
        document.querySelector(
          `input[name="type"][value="${item.type}"]`
        ).checked = true;
        document.getElementById("title").value = item.title;
        document.getElementById("description").value = item.description;
        document.getElementById("location").value = item.location;

        // Set image preview if exists
        if (item.image) {
          previewImage.src = item.image.startsWith("/uploads/")
            ? item.image
            : `/uploads/${item.image}`;
          imagePreview.classList.remove("hidden");
        }

        // Clear existing questions
        questionsContainer.innerHTML = "";
        questionCount = 0;

        // Add questions from the item
        item.validityQuestions.forEach((question, index) => {
          addQuestion(question.question, question.answer);
        });

        // Update UI for edit mode
        document.querySelector("h2").textContent = "Edit Item";
        submitBtn.textContent = "Update Item";
      }

      // Add a new question field
      function addQuestion(question = "", answer = "") {
        if (questionCount >= 10) {
          alert("Maximum 10 questions allowed");
          return;
        }

        questionCount++;

        const questionDiv = document.createElement("div");
        questionDiv.className =
          "question-group mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200";
        questionDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="text-slate-700 font-medium">Question #${questionCount}</label>
                    <button type="button" class="remove-question text-red-600 text-sm font-medium hover:text-red-800 transition">
                        <i class="fas fa-trash mr-1"></i> Remove
                    </button>
                </div>
                <input type="text" name="questions[${
                  questionCount - 1
                }][question]" required
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition mb-2"
                    placeholder="Enter verification question" value="${question}">
                <input type="text" name="questions[${
                  questionCount - 1
                }][answer]" required
                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                    placeholder="Enter expected answer (only visible to you)" value="${answer}">
            `;

        questionsContainer.appendChild(questionDiv);

        // Add event listener to remove button
        questionDiv
          .querySelector(".remove-question")
          .addEventListener("click", () => {
            if (questionCount <= 1) {
              alert("At least one question is required");
              return;
            }

            questionDiv.remove();
            questionCount--;
            reindexQuestions();
          });
      }

      // Reindex questions after one is removed
      function reindexQuestions() {
        const questionGroups =
          questionsContainer.querySelectorAll(".question-group");

        questionGroups.forEach((group, index) => {
          const label = group.querySelector("label");
          const questionInput = group.querySelector(
            'input[name^="questions["][name$="[question]"]'
          );
          const answerInput = group.querySelector(
            'input[name^="questions["][name$="[answer]"]'
          );

          // Update question number in label
          label.textContent = `Question #${index + 1}`;

          // Update input names to maintain proper indexing
          questionInput.name = `questions[${index}][question]`;
          answerInput.name = `questions[${index}][answer]`;
        });
      }

      // Setup event listeners
      function setupEventListeners() {
        // Add question button
        addQuestionBtn.addEventListener("click", () => {
          addQuestion();
        });

        // Image upload preview
        imageInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
              previewImage.src = e.target.result;
              imagePreview.classList.remove("hidden");
            };

            reader.readAsDataURL(this.files[0]);
          }
        });

        // Remove image button
        removeImage.addEventListener("click", function () {
          imageInput.value = "";
          imagePreview.classList.add("hidden");
          previewImage.src = "#";
        });

        // Cancel button
        cancelBtn.addEventListener("click", function () {
          if (
            confirm(
              "Are you sure you want to cancel? Any unsaved changes will be lost."
            )
          ) {
            window.location.href = "home.html";
          }
        });

        // Edit item button (in success message)
        editItemBtn.addEventListener("click", function () {
          successMessage.classList.add("hidden");
          itemForm.classList.remove("hidden");
        });

        // Logout button
        logoutBtn.addEventListener("click", function () {
          localStorage.removeItem("token");
          window.location.href = "login.html";
        });

        // Form submission
        itemForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Validate at least one question exists
          if (questionCount < 1) {
            alert("Please add at least one verification question");
            return;
          }

          if (
            !confirm(
              isEditMode
                ? "Are you sure you want to update this item?"
                : "Are you sure you want to post this item?"
            )
          ) {
            return;
          }

          try {
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

            const formData = new FormData(itemForm);
            const questions = [];

            // Collect questions and answers
            const questionInputs = itemForm.querySelectorAll(
              'input[name^="questions["][name$="[question]"]'
            );
            const answerInputs = itemForm.querySelectorAll(
              'input[name^="questions["][name$="[answer]"]'
            );

            questionInputs.forEach((input, index) => {
              questions.push({
                question: input.value,
                answer: answerInputs[index].value,
              });
            });

            // Add questions to form data
            formData.set("validityQuestions", JSON.stringify(questions));

            const url = isEditMode
              ? `/api/items/${currentItemId}`
              : "/api/items";
            const method = isEditMode ? "PUT" : "POST";

            const response = await fetch(url, {
              method: method,
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            });

            if (!response.ok) {
              throw new Error("Failed to submit item");
            }

            const data = await response.json();

            // Show success message
            itemForm.classList.add("hidden");
            successMessage.classList.remove("hidden");

            // Update edit button to point to this item
            if (!isEditMode) {
              currentItemId = data.item._id;
              editItemBtn.textContent = "Edit This Item";
            }

            isEditMode = true;
          } catch (error) {
            console.error("Error submitting item:", error);
            alert("Failed to submit item. Please try again.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isEditMode ? "Update Item" : "Post Item";
          }
        });
      }
    </script>
  </body>
</html>
