<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Item Details | BUP Lost & Found</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      :root {
        --reddit-orange: #ff4500;
        --reddit-blue: #0079d3;
        --dark-bg: #030303;
        --card-bg: #1a1a1b;
        --hover-bg: #272729;
        --text-primary: #d7dadc;
        --text-secondary: #818384;
        --border-color: #343536;
        --error-color: #ea0027;
        --success-color: #46d160;
        --lost-accent: #ff3333;
        --found-accent: #33ff33;
        --warning-color: #ffa500;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--dark-bg);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 12px 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--text-primary);
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--reddit-orange);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: 600;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .nav-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .nav-btn:hover {
        background: var(--border-color);
        color: var(--text-primary);
      }

      .nav-btn.danger:hover {
        background: var(--error-color);
        border-color: var(--error-color);
      }

      /* Main Container */
      .main-container {
        max-width: 1200px;
        margin: 80px auto 40px;
        padding: 0 16px;
      }

      .item-container {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-bottom: 24px;
      }

      /* Item Header */
      .item-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .item-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--text-primary);
      }

      .item-meta {
        display: flex;
        align-items: center;
        gap: 24px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 14px;
      }

      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-lost {
        background: rgba(255, 51, 51, 0.2);
        color: var(--lost-accent);
        border: 1px solid var(--lost-accent);
      }

      .badge-found {
        background: rgba(51, 255, 51, 0.2);
        color: var(--found-accent);
        border: 1px solid var(--found-accent);
      }

      .badge-active {
        background: rgba(0, 121, 211, 0.2);
        color: var(--reddit-blue);
        border: 1px solid var(--reddit-blue);
      }

      .badge-claimed {
        background: rgba(70, 209, 96, 0.2);
        color: var(--success-color);
        border: 1px solid var(--success-color);
      }

      /* Item Content */
      .item-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        padding: 24px;
      }

      .item-image-section {
        position: relative;
      }

      .item-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .no-image-placeholder {
        width: 100%;
        height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--hover-bg);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
      }

      .no-image-placeholder i {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .item-details-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .description-card {
        background: var(--hover-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .description-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-primary);
      }

      .description-text {
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .posted-by-card {
        background: var(--hover-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border-color);
      }

      .user-details h4 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .user-details p {
        color: var(--text-secondary);
        font-size: 14px;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--reddit-orange);
        color: white;
      }

      .btn-primary:hover {
        background: #e03e00;
      }

      .btn-secondary {
        background: var(--hover-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-color);
      }

      .btn-success {
        background: var(--success-color);
        color: white;
      }

      .btn-success:hover {
        background: #3cb050;
      }

      .btn-danger {
        background: var(--error-color);
        color: white;
      }

      .btn-danger:hover {
        background: #cc0020;
      }

      /* Tabs */
      .tabs-container {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
      }

      .tabs-nav {
        display: flex;
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border-color);
      }

      .tab-btn {
        flex: 1;
        padding: 16px 24px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .tab-btn.active {
        color: var(--reddit-orange);
        background: var(--card-bg);
      }

      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--reddit-orange);
      }

      .tab-content {
        padding: 24px;
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Comments */
      .comment-form {
        margin-bottom: 32px;
      }

      .comment-textarea {
        width: 100%;
        min-height: 100px;
        padding: 16px;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: inherit;
        resize: vertical;
        margin-bottom: 12px;
      }

      .comment-textarea:focus {
        outline: none;
        border-color: var(--reddit-orange);
      }

      .comment-card {
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
      }

      .comment-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .comment-user {
        font-weight: 600;
        color: var(--text-primary);
      }

      .comment-time {
        color: var(--text-secondary);
        font-size: 12px;
      }

      .comment-content {
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .comment-actions {
        margin-top: 12px;
        display: flex;
        gap: 12px;
      }

      .comment-edit-form {
        display: none;
        margin-top: 12px;
      }

      /* Requests */
      .request-card {
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
      }

      .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .request-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background: rgba(255, 165, 0, 0.2);
        color: var(--warning-color);
        border: 1px solid var(--warning-color);
      }

      .status-approved {
        background: rgba(70, 209, 96, 0.2);
        color: var(--success-color);
        border: 1px solid var(--success-color);
      }

      .status-rejected {
        background: rgba(234, 0, 39, 0.2);
        color: var(--error-color);
        border: 1px solid var(--error-color);
      }

      .request-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      }

      .modal {
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
      }

      .modal-close:hover {
        color: var(--text-primary);
      }

      .modal-body {
        padding: 24px;
      }

      .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .form-input,
      .form-textarea {
        width: 100%;
        padding: 12px 16px;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-family: inherit;
      }

      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--reddit-orange);
      }

      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      .file-upload {
        position: relative;
        display: inline-block;
        cursor: pointer;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-upload-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .file-upload:hover .file-upload-btn {
        background: var(--border-color);
      }

      .image-preview {
        margin-top: 12px;
        display: none;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      /* Loading */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border-color);
        border-top-color: var(--reddit-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .main-container {
          margin-top: 70px;
          padding: 0 8px;
        }

        .item-content {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .item-meta {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .tabs-nav {
          flex-direction: column;
        }

        .action-buttons {
          flex-direction: column;
        }

        .modal {
          margin: 20px;
          max-width: none;
        }
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .contact-info-card {
        background: var(--hover-bg);
        border: 1px solid var(--success-color);
        border-radius: 8px;
        padding: 20px;
        margin-top: 16px;
      }

      .contact-info-title {
        color: var(--success-color);
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .contact-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }

      .contact-item strong {
        color: var(--text-primary);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="home.html" class="logo">
          <div class="logo-icon">
            <i class="fas fa-search-location"></i>
          </div>
          <span class="logo-text">BUP Lost & Found</span>
        </a>
        <div class="nav-actions">
          <a href="home.html" class="nav-btn">
            <i class="fas fa-home"></i>
            <span>Home</span>
          </a>
          <a href="profile.html" class="nav-btn">
            <i class="fas fa-user"></i>
            <span>Profile</span>
          </a>
          <button id="logoutBtn" class="nav-btn danger">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Item Container -->
      <div class="item-container">
        <!-- Item Header -->
        <div class="item-header">
          <h1 id="itemTitle" class="item-title">Loading...</h1>
          <div class="item-meta">
            <div class="meta-item">
              <i class="fas fa-map-marker-alt"></i>
              <span id="itemLocation">-</span>
            </div>
            <div class="meta-item">
              <i class="far fa-clock"></i>
              <span id="itemDate">-</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-eye"></i>
              <span id="itemViews">0</span> views
            </div>
            <span id="itemTypeBadge" class="badge">-</span>
            <span id="itemStatusBadge" class="badge">-</span>
          </div>
        </div>

        <!-- Item Content -->
        <div class="item-content">
          <!-- Image Section -->
          <div class="item-image-section">
            <div id="itemImageContainer">
              <div class="loading">
                <div class="spinner"></div>
                Loading image...
              </div>
            </div>
          </div>

          <!-- Details Section -->
          <div class="item-details-section">
            <!-- Description -->
            <div class="description-card">
              <h3 class="description-title">
                <i class="fas fa-align-left"></i>
                Description
              </h3>
              <p id="itemDescription" class="description-text">Loading...</p>
            </div>

            <!-- Posted By -->
            <div class="posted-by-card">
              <h3 class="description-title">
                <i class="fas fa-user"></i>
                Posted By
              </h3>
              <div class="user-info">
                <img
                  id="postedByAvatar"
                  src=""
                  alt="User Avatar"
                  class="user-avatar"
                />
                <div class="user-details">
                  <h4 id="postedByName">Loading...</h4>
                  <p id="postedByDepartment">-</p>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons" class="action-buttons">
              <!-- Buttons will be dynamically added here -->
            </div>

            <!-- Contact Info (for approved claims) -->
            <div
              id="contactInfoCard"
              class="contact-info-card"
              style="display: none"
            >
              <div class="contact-info-title">
                <i class="fas fa-phone"></i>
                Contact Information
              </div>
              <div id="contactInfoContent">
                <!-- Contact details will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Container -->
      <div class="tabs-container">
        <div class="tabs-nav">
          <button class="tab-btn active" data-tab="comments">
            <i class="fas fa-comments"></i>
            Comments
          </button>
          <button
            class="tab-btn"
            data-tab="requests"
            id="requestsTab"
            style="display: none"
          >
            <i class="fas fa-hand-holding"></i>
            <span id="requestsTabText">Requests</span>
          </button>
        </div>

        <!-- Comments Tab -->
        <div class="tab-content active" id="commentsTab">
          <div class="comment-form">
            <textarea
              id="commentText"
              class="comment-textarea"
              placeholder="Write your comment here..."
            ></textarea>
            <button id="submitCommentBtn" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i>
              Post Comment
            </button>
          </div>
          <div id="commentsContainer">
            <div class="loading">
              <div class="spinner"></div>
              Loading comments...
            </div>
          </div>
        </div>

        <!-- Requests Tab -->
        <div class="tab-content" id="requestsTabContent">
          <div id="requestsContainer">
            <div class="loading">
              <div class="spinner"></div>
              Loading requests...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Claim Modal (for found items) -->
    <div class="modal-overlay" id="claimModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Claim This Item</h3>
          <button class="modal-close" onclick="closeModal('claimModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="claimQuestionsContainer">
            <!-- Questions will be loaded here -->
          </div>
          <div class="form-group">
            <label class="form-label">Additional Information</label>
            <textarea
              id="additionalInfo"
              class="form-textarea"
              placeholder="Provide any additional information that might help verify your claim..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('claimModal')">
            Cancel
          </button>
          <button id="submitClaimBtn" class="btn btn-success">
            <i class="fas fa-check"></i>
            Submit Claim
          </button>
        </div>
      </div>
    </div>

    <!-- Inform Modal (for lost items) -->
    <div class="modal-overlay" id="informModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Inform About Found Item</h3>
          <button class="modal-close" onclick="closeModal('informModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Message *</label>
            <textarea
              id="informMessage"
              class="form-textarea"
              placeholder="Describe the item you found and where you found it..."
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Image (Optional)</label>
            <div class="file-upload">
              <input
                type="file"
                id="informImage"
                class="file-input"
                accept="image/*"
              />
              <div class="file-upload-btn">
                <i class="fas fa-camera"></i>
                <span>Upload Image</span>
              </div>
            </div>
            <div id="informImagePreview" class="image-preview">
              <img
                id="informPreviewImage"
                src=""
                alt="Preview"
                class="preview-image"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('informModal')">
            Cancel
          </button>
          <button id="submitInformBtn" class="btn btn-primary">
            <i class="fas fa-info-circle"></i>
            Submit Information
          </button>
        </div>
      </div>
    </div>

    <!-- Message Modal -->
    <div class="modal-overlay" id="messageModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Send Message</h3>
          <button class="modal-close" onclick="closeModal('messageModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Message</label>
            <textarea
              id="messageContent"
              class="form-textarea"
              placeholder="Write your message here..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('messageModal')"
          >
            Cancel
          </button>
          <button id="sendMessageBtn" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i>
            Send Message
          </button>
        </div>
      </div>
    </div>

    <!-- Contact Info Modal -->
    <div class="modal-overlay" id="contactModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Provide Contact Information</h3>
          <button class="modal-close" onclick="closeModal('contactModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Phone Number *</label>
            <input
              type="tel"
              id="contactPhone"
              class="form-input"
              placeholder="Your phone number"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Alternate Phone</label>
            <input
              type="tel"
              id="contactAltPhone"
              class="form-input"
              placeholder="Alternate phone number"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              type="email"
              id="contactEmail"
              class="form-input"
              placeholder="Your email address"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Meeting Location</label>
            <input
              type="text"
              id="contactLocation"
              class="form-input"
              placeholder="Preferred meeting location"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Meeting Time</label>
            <input
              type="text"
              id="contactTime"
              class="form-input"
              placeholder="Preferred meeting time"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Additional Notes</label>
            <textarea
              id="contactNotes"
              class="form-textarea"
              placeholder="Any additional notes..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('contactModal')"
          >
            Cancel
          </button>
          <button id="approveWithContactBtn" class="btn btn-success">
            <i class="fas fa-check"></i>
            Approve & Share Contact
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let currentItem = null;
      let currentRequestId = null;
      let currentRequestType = null;

      // DOM elements
      const itemTitleEl = document.getElementById("itemTitle");
      const itemLocationEl = document.getElementById("itemLocation");
      const itemDateEl = document.getElementById("itemDate");
      const itemViewsEl = document.getElementById("itemViews");
      const itemTypeBadgeEl = document.getElementById("itemTypeBadge");
      const itemStatusBadgeEl = document.getElementById("itemStatusBadge");
      const itemImageContainerEl =
        document.getElementById("itemImageContainer");
      const itemDescriptionEl = document.getElementById("itemDescription");
      const postedByAvatarEl = document.getElementById("postedByAvatar");
      const postedByNameEl = document.getElementById("postedByName");
      const postedByDepartmentEl =
        document.getElementById("postedByDepartment");
      const actionButtonsEl = document.getElementById("actionButtons");
      const contactInfoCardEl = document.getElementById("contactInfoCard");
      const contactInfoContentEl =
        document.getElementById("contactInfoContent");

      // Helper function to format profile image URL
      function formatProfileImageUrl(user) {
        if (user.profileImage) {
          if (user.profileImage.startsWith("/uploads/")) {
            return user.profileImage;
          } else {
            return `/uploads/${user.profileImage}`;
          }
        }
        return (
          "https://via.placeholder.com/48x48/1a1a1b/d7dadc?text=" +
          user.firstName.charAt(0).toUpperCase() +
          user.lastName.charAt(0).toUpperCase()
        );
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuth();
        await loadUserData();

        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get("id");

        if (itemId) {
          await loadItem(itemId);
          setupEventListeners();
          setupTabs();
        } else {
          window.location.href = "home.html";
        }
      });

      // Authentication check
      async function checkAuth() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
      }

      // Load user data
      async function loadUserData() {
        try {
          const response = await fetch("/api/users/me", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to fetch user data");

          const data = await response.json();
          currentUser = data.user;
        } catch (error) {
          console.error("Error loading user data:", error);
          window.location.href = "login.html";
        }
      }

      // Load item details
      async function loadItem(itemId) {
        try {
          const response = await fetch(`/api/items/${itemId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) throw new Error("Failed to load item");

          const data = await response.json();
          currentItem = data.item;

          displayItemDetails();
          setupActionButtons();
          loadComments();

          if (currentUser.id === currentItem.postedBy._id) {
            document.getElementById("requestsTab").style.display = "block";
            document.getElementById("requestsTabText").textContent =
              currentItem.type === "found"
                ? "Claim Requests"
                : "Inform Requests";
            loadRequests();
          }

          if (
            currentItem.status === "claimed" &&
            currentItem.claimedBy &&
            currentItem.claimedBy._id === currentUser.id
          ) {
            loadContactInfo();
          }
        } catch (error) {
          console.error("Error loading item:", error);
          window.location.href = "home.html";
        }
      }

      // Display item details
      function displayItemDetails() {
        itemTitleEl.textContent = currentItem.title;
        itemLocationEl.textContent = currentItem.location;
        itemDescriptionEl.textContent = currentItem.description;
        itemViewsEl.textContent = currentItem.viewCount || 0;

        const date = new Date(currentItem.createdAt);
        itemDateEl.textContent =
          date.toLocaleDateString() + " at " + date.toLocaleTimeString();

        itemTypeBadgeEl.textContent =
          currentItem.type.charAt(0).toUpperCase() + currentItem.type.slice(1);
        itemTypeBadgeEl.className = `badge badge-${currentItem.type}`;

        itemStatusBadgeEl.textContent =
          currentItem.status.charAt(0).toUpperCase() +
          currentItem.status.slice(1);
        itemStatusBadgeEl.className = `badge badge-${currentItem.status}`;

        if (currentItem.image) {
          const imageUrl = currentItem.image.startsWith("/uploads/")
            ? currentItem.image
            : `/uploads/${currentItem.image}`;

          itemImageContainerEl.innerHTML = `
                    <img src="${imageUrl}" alt="${currentItem.title}" class="item-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="no-image-placeholder" style="display:none;">
                        <i class="fas fa-image"></i>
                        <p>Image not available</p>
                    </div>
                `;
        } else {
          itemImageContainerEl.innerHTML = `
                    <div class="no-image-placeholder">
                        <i class="fas fa-image"></i>
                        <p>No Image Available</p>
                    </div>
                `;
        }

        postedByNameEl.textContent = `${currentItem.postedBy.firstName} ${currentItem.postedBy.lastName}`;
        postedByDepartmentEl.textContent = currentItem.postedBy.department;

        const avatarUrl = formatProfileImageUrl(currentItem.postedBy);
        postedByAvatarEl.src = avatarUrl;
        postedByAvatarEl.onerror = function () {
          this.src =
            "https://via.placeholder.com/48x48/1a1a1b/d7dadc?text=" +
            currentItem.postedBy.firstName.charAt(0).toUpperCase() +
            currentItem.postedBy.lastName.charAt(0).toUpperCase();
        };
      }

      // Setup action buttons
      function setupActionButtons() {
        actionButtonsEl.innerHTML = "";

        if (currentUser.id === currentItem.postedBy._id) {
          if (currentItem.status === "claimed") {
            const claimedByUser = currentItem.claimedBy;
            actionButtonsEl.innerHTML = `
                        <div class="btn btn-success">
                            <i class="fas fa-check-circle"></i>
                            Claimed by ${claimedByUser.firstName} ${claimedByUser.lastName}
                        </div>
                    `;
          }
        } else {
          if (currentItem.status === "active") {
            if (currentItem.type === "found") {
              actionButtonsEl.innerHTML = `
                            <button class="btn btn-primary" onclick="openClaimModal()">
                                <i class="fas fa-hand-holding"></i>
                                Claim Item
                            </button>
                        `;
            } else {
              actionButtonsEl.innerHTML = `
                            <button class="btn btn-primary" onclick="openInformModal()">
                                <i class="fas fa-info-circle"></i>
                                I Found This
                            </button>
                        `;
            }
          }

          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-secondary";
          messageBtn.onclick = () => openModal("messageModal");
          messageBtn.innerHTML = `
                    <i class="fas fa-envelope"></i>
                    Message Owner
                `;
          actionButtonsEl.appendChild(messageBtn);
        }
      }

      // Load comments
      async function loadComments() {
        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/comments`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) throw new Error("Failed to load comments");

          const data = await response.json();
          displayComments(data.comments);
        } catch (error) {
          console.error("Error loading comments:", error);
          document.getElementById("commentsContainer").innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load comments</p>
                    </div>
                `;
        }
      }

      // Display comments
      function displayComments(comments) {
        const container = document.getElementById("commentsContainer");

        if (comments.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No comments yet. Be the first to comment!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = comments
          .map((comment) => {
            const date = new Date(comment.createdAt);
            const avatarUrl = formatProfileImageUrl(comment.postedBy);
            const isOwnComment = currentUser.id === comment.postedBy._id;

            return `
                    <div class="comment-card" id="comment-${comment._id}">
                        <div class="comment-header">
                            <img src="${avatarUrl}" alt="${
              comment.postedBy.firstName
            }" class="user-avatar" style="width: 32px; height: 32px;" 
                                 onerror="this.src='https://via.placeholder.com/32x32/1a1a1b/d7dadc?text=${comment.postedBy.firstName
                                   .charAt(0)
                                   .toUpperCase()}${comment.postedBy.lastName
              .charAt(0)
              .toUpperCase()}';">
                            <div>
                                <span class="comment-user">${
                                  comment.postedBy.firstName
                                } ${comment.postedBy.lastName}</span>
                                <span class="comment-time">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</span>
                            </div>
                        </div>
                        <div class="comment-content" id="comment-content-${
                          comment._id
                        }">${comment.content}</div>
                        ${
                          isOwnComment
                            ? `
                            <div class="comment-actions">
                                <button class="btn btn-secondary btn-sm" onclick="editComment('${comment._id}')">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteComment('${comment._id}')">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </div>
                            <div class="comment-edit-form" id="edit-form-${comment._id}">
                                <textarea class="comment-textarea" id="edit-text-${comment._id}">${comment.content}</textarea>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="submitEditComment('${comment._id}')">
                                        <i class="fas fa-save"></i>
                                        Save
                                    </button>
                                    <button class="btn btn-secondary" onclick="cancelEdit('${comment._id}')">
                                        <i class="fas fa-times"></i>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      // Edit comment
      function editComment(commentId) {
        document.getElementById(`comment-content-${commentId}`).style.display =
          "none";
        document.getElementById(`edit-form-${commentId}`).style.display =
          "block";
        document.querySelector(
          `#comment-${commentId} .comment-actions`
        ).style.display = "none";
      }

      // Cancel edit
      function cancelEdit(commentId) {
        document.getElementById(`comment-content-${commentId}`).style.display =
          "block";
        document.getElementById(`edit-form-${commentId}`).style.display =
          "none";
        document.querySelector(
          `#comment-${commentId} .comment-actions`
        ).style.display = "flex";
      }

      // Submit edited comment
      async function submitEditComment(commentId) {
        const content = document
          .getElementById(`edit-text-${commentId}`)
          .value.trim();
        if (!content) {
          alert("Comment cannot be empty");
          return;
        }

        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/comments/${commentId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ content }),
            }
          );

          if (!response.ok) throw new Error("Failed to update comment");

          loadComments();
        } catch (error) {
          console.error("Error updating comment:", error);
          alert("Failed to update comment. Please try again.");
        }
      }

      // Delete comment
      async function deleteComment(commentId) {
        if (!confirm("Are you sure you want to delete this comment?")) return;

        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/comments/${commentId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) throw new Error("Failed to delete comment");

          loadComments();
        } catch (error) {
          console.error("Error deleting comment:", error);
          alert("Failed to delete comment. Please try again.");
        }
      }

      // Load requests (claim or inform)
      async function loadRequests() {
        try {
          const endpoint =
            currentItem.type === "found" ? "claim-requests" : "inform-requests";
          const response = await fetch(
            `/api/items/${currentItem._id}/${endpoint}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) throw new Error("Failed to load requests");

          const data = await response.json();
          const requests =
            currentItem.type === "found"
              ? data.claimRequests
              : data.informRequests;
          displayRequests(requests);
        } catch (error) {
          console.error("Error loading requests:", error);
          document.getElementById("requestsContainer").innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load requests</p>
                    </div>
                `;
        }
      }

      // Display requests
      function displayRequests(requests) {
        const container = document.getElementById("requestsContainer");

        if (requests.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-hand-holding"></i>
                        <p>No requests yet.</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = requests
          .map((request) => {
            const date = new Date(request.createdAt);
            const userKey =
              currentItem.type === "found" ? "requestedBy" : "informedBy";
            const user = request[userKey];

            const avatarUrl = formatProfileImageUrl(user);

            return `
                    <div class="request-card">
                        <div class="request-header">
                            <div class="user-info">
                                <img src="${avatarUrl}" alt="${
              user.firstName
            }" class="user-avatar" style="width: 40px; height: 40px;"
                                     onerror="this.src='https://via.placeholder.com/40x40/1a1a1b/d7dadc?text=${user.firstName
                                       .charAt(0)
                                       .toUpperCase()}${user.lastName
              .charAt(0)
              .toUpperCase()}';">
                                <div class="user-details">
                                    <h4>${user.firstName} ${user.lastName}</h4>
                                    <p>${date.toLocaleDateString()}</p>
                                </div>
                            </div>
                            <span class="request-status status-${
                              request.status
                            }">${request.status}</span>
                        </div>
                        
                        ${
                          currentItem.type === "found" && request.answers
                            ? `
                            <div style="margin: 16px 0;">
                                <strong>Answers to Verification Questions:</strong>
                                <div style="margin-top: 8px;">
                                    ${currentItem.validityQuestions
                                      .map(
                                        (question, index) => `
                                        <div style="margin-bottom: 12px; padding: 12px; background: var(--dark-bg); border-radius: 6px;">
                                            <strong>Q${index + 1}: ${
                                          question.question
                                        }</strong><br>
                                            <span style="color: var(--text-secondary);">A: ${
                                              request.answers[index] ||
                                              "No answer provided"
                                            }</span>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          currentItem.type === "lost" && request.message
                            ? `
                            <div style="margin: 16px 0;">
                                <strong>Message:</strong>
                                <p style="margin-top: 8px; color: var(--text-secondary);">${request.message}</p>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          request.additionalInfo
                            ? `
                            <div style="margin: 16px 0;">
                                <strong>Additional Information:</strong>
                                <p style="margin-top: 8px; color: var(--text-secondary);">${request.additionalInfo}</p>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          request.image
                            ? `
                            <div style="margin: 16px 0;">
                                <strong>Attached Image:</strong>
                                <img src="${request.image}" alt="Request image" style="max-width: 100%; max-height: 200px; border-radius: 6px; margin-top: 8px;">
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          request.status === "pending"
                            ? `
                            <div class="request-actions">
                                <button class="btn btn-success" onclick="approveRequest('${request._id}')">
                                    <i class="fas fa-check"></i>
                                    Approve
                                </button>
                                <button class="btn btn-danger" onclick="rejectRequest('${request._id}')">
                                    <i class="fas fa-times"></i>
                                    Reject
                                </button>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      // Load contact info for approved claims
      async function loadContactInfo() {
        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/contact-info`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            displayContactInfo(data.contactInfo, data.itemOwner);
          }
        } catch (error) {
          console.error("Error loading contact info:", error);
        }
      }

      // Display contact info
      function displayContactInfo(contactInfo, itemOwner) {
        contactInfoContentEl.innerHTML = `
                <div class="contact-item">
                    <i class="fas fa-user"></i>
                    <strong>Owner:</strong> ${itemOwner.name}
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <strong>Phone:</strong> ${contactInfo.phone}
                </div>
                ${
                  contactInfo.alternatePhone
                    ? `
                    <div class="contact-item">
                        <i class="fas fa-phone-alt"></i>
                        <strong>Alternate Phone:</strong> ${contactInfo.alternatePhone}
                    </div>
                `
                    : ""
                }
                ${
                  contactInfo.email
                    ? `
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <strong>Email:</strong> ${contactInfo.email}
                    </div>
                `
                    : ""
                }
                ${
                  contactInfo.meetingLocation
                    ? `
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <strong>Meeting Location:</strong> ${contactInfo.meetingLocation}
                    </div>
                `
                    : ""
                }
                ${
                  contactInfo.meetingTime
                    ? `
                    <div class="contact-item">
                        <i class="fas fa-clock"></i>
                        <strong>Meeting Time:</strong> ${contactInfo.meetingTime}
                    </div>
                `
                    : ""
                }
                ${
                  contactInfo.additionalNotes
                    ? `
                    <div class="contact-item">
                        <i class="fas fa-sticky-note"></i>
                        <strong>Notes:</strong> ${contactInfo.additionalNotes}
                    </div>
                `
                    : ""
                }
            `;
        contactInfoCardEl.style.display = "block";
      }

      // Setup event listeners
      function setupEventListeners() {
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "login.html";
        });

        document
          .getElementById("submitCommentBtn")
          .addEventListener("click", submitComment);

        document
          .getElementById("submitClaimBtn")
          .addEventListener("click", submitClaim);

        document
          .getElementById("submitInformBtn")
          .addEventListener("click", submitInform);

        document
          .getElementById("sendMessageBtn")
          .addEventListener("click", sendMessage);

        document
          .getElementById("approveWithContactBtn")
          .addEventListener("click", approveWithContact);

        document
          .getElementById("informImage")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                document.getElementById("informPreviewImage").src =
                  e.target.result;
                document.getElementById("informImagePreview").style.display =
                  "block";
              };
              reader.readAsDataURL(file);
            } else {
              document.getElementById("informImagePreview").style.display =
                "none";
            }
          });
      }

      // Setup tabs
      function setupTabs() {
        const tabBtns = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        tabBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const targetTab = btn.dataset.tab;

            tabBtns.forEach((b) => b.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));

            btn.classList.add("active");
            document.getElementById(targetTab + "Tab").classList.add("active");
          });
        });
      }

      // Modal functions
      function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";

        if (modalId === "claimModal") {
          document.getElementById("additionalInfo").value = "";
          document.getElementById("claimQuestionsContainer").innerHTML = "";
        } else if (modalId === "informModal") {
          document.getElementById("informMessage").value = "";
          document.getElementById("informImage").value = "";
          document.getElementById("informImagePreview").style.display = "none";
        } else if (modalId === "messageModal") {
          document.getElementById("messageContent").value = "";
        } else if (modalId === "contactModal") {
          document.getElementById("contactPhone").value = "";
          document.getElementById("contactAltPhone").value = "";
          document.getElementById("contactEmail").value = "";
          document.getElementById("contactLocation").value = "";
          document.getElementById("contactTime").value = "";
          document.getElementById("contactNotes").value = "";
        }
      }

      // Open claim modal
      function openClaimModal() {
        const container = document.getElementById("claimQuestionsContainer");

        if (
          currentItem.validityQuestions &&
          currentItem.validityQuestions.length > 0
        ) {
          container.innerHTML = currentItem.validityQuestions
            .map(
              (question, index) => `
                    <div class="form-group">
                        <label class="form-label">${index + 1}. ${
                question.question
              }</label>
                        <input type="text" class="form-input" id="answer-${index}" required>
                    </div>
                `
            )
            .join("");
        } else {
          container.innerHTML =
            "<p>Please provide any information that can help verify your claim.</p>";
        }

        openModal("claimModal");
      }

      // Open inform modal
      function openInformModal() {
        openModal("informModal");
      }

      // Submit comment
      async function submitComment() {
        const content = document.getElementById("commentText").value.trim();
        if (!content) {
          alert("Please enter a comment");
          return;
        }

        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/comments`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ content }),
            }
          );

          if (!response.ok) throw new Error("Failed to post comment");

          document.getElementById("commentText").value = "";
          loadComments();
        } catch (error) {
          console.error("Error submitting comment:", error);
          alert("Failed to post comment. Please try again.");
        }
      }

      // Submit claim
      async function submitClaim() {
        const answers = [];
        let allAnswered = true;

        if (
          currentItem.validityQuestions &&
          currentItem.validityQuestions.length > 0
        ) {
          currentItem.validityQuestions.forEach((_, index) => {
            const answer = document
              .getElementById(`answer-${index}`)
              .value.trim();
            if (!answer) allAnswered = false;
            answers.push(answer);
          });

          if (!allAnswered) {
            alert("Please answer all verification questions");
            return;
          }
        }

        const additionalInfo = document
          .getElementById("additionalInfo")
          .value.trim();

        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/claim-request`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ answers, additionalInfo }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to submit claim");
          }

          closeModal("claimModal");
          alert(
            "Claim request submitted successfully! The item owner will review your request."
          );
          await loadItem(currentItem._id);
        } catch (error) {
          console.error("Error submitting claim:", error);
          alert(error.message || "Failed to submit claim. Please try again.");
        }
      }

      // Submit inform
      async function submitInform() {
        const message = document.getElementById("informMessage").value.trim();
        if (!message) {
          alert("Please provide a message describing the found item");
          return;
        }

        const formData = new FormData();
        formData.append("message", message);

        const imageFile = document.getElementById("informImage").files[0];
        if (imageFile) {
          formData.append("image", imageFile);
        }

        try {
          const response = await fetch(
            `/api/items/${currentItem._id}/inform-request`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || "Failed to submit inform request"
            );
          }

          closeModal("informModal");
          alert(
            "Information submitted successfully! The item owner will review your message."
          );
          await loadItem(currentItem._id);
        } catch (error) {
          console.error("Error submitting inform:", error);
          alert(
            error.message || "Failed to submit information. Please try again."
          );
        }
      }

      // Send message
      async function sendMessage() {
        const content = document.getElementById("messageContent").value.trim();
        if (!content) {
          alert("Please enter a message");
          return;
        }

        try {
          const response = await fetch("/api/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              receiver: currentItem.postedBy._id,
              content,
            }),
          });

          if (!response.ok) throw new Error("Failed to send message");

          closeModal("messageModal");
          alert("Message sent successfully!");
        } catch (error) {
          console.error("Error sending message:", error);
          alert("Failed to send message. Please try again.");
        }
      }

      // Approve request
      function approveRequest(requestId) {
        currentRequestId = requestId;
        currentRequestType = currentItem.type === "found" ? "claim" : "inform";

        document.getElementById("contactEmail").value = currentUser.email;

        openModal("contactModal");
      }

      // Approve with contact
      async function approveWithContact() {
        const phone = document.getElementById("contactPhone").value.trim();
        if (!phone) {
          alert("Phone number is required");
          return;
        }

        const contactInfo = {
          phone,
          alternatePhone: document
            .getElementById("contactAltPhone")
            .value.trim(),
          email: document.getElementById("contactEmail").value.trim(),
          meetingLocation: document
            .getElementById("contactLocation")
            .value.trim(),
          meetingTime: document.getElementById("contactTime").value.trim(),
          additionalNotes: document.getElementById("contactNotes").value.trim(),
        };

        try {
          const endpoint =
            currentRequestType === "claim"
              ? "claim-requests"
              : "inform-requests";
          const response = await fetch(
            `/api/items/${currentItem._id}/${endpoint}/${currentRequestId}/approve`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ contactInfo }),
            }
          );

          if (!response.ok) throw new Error("Failed to approve request");

          closeModal("contactModal");
          alert(
            "Request approved successfully! Contact information has been shared."
          );
          await loadItem(currentItem._id);
        } catch (error) {
          console.error("Error approving request:", error);
          alert("Failed to approve request. Please try again.");
        }
      }

      // Reject request
      async function rejectRequest(requestId) {
        const reason = prompt(
          "Please provide a reason for rejection (optional):"
        );

        try {
          const endpoint =
            currentItem.type === "found" ? "claim-requests" : "inform-requests";
          const response = await fetch(
            `/api/items/${currentItem._id}/${endpoint}/${requestId}/reject`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ rejectionReason: reason || "" }),
            }
          );

          if (!response.ok) throw new Error("Failed to reject request");

          alert("Request rejected successfully.");
          loadRequests();
        } catch (error) {
          console.error("Error rejecting request:", error);
          alert("Failed to reject request. Please try again.");
        }
      }

      // Close modals when clicking outside
      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
