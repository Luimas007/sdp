<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - BUP Lost & Found</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              reddit: {
                dark: "#0b1426",
                darker: "#030a19",
                card: "#1a1a1b",
                border: "#343536",
                text: "#d7dadc",
                muted: "#818384",
                accent: "#ff4500",
                upvote: "#ff8700",
                orange: "#ff4500",
              },
              primary: {
                50: "#fef2f2",
                100: "#fee2e2",
                200: "#fecaca",
                300: "#fca5a5",
                400: "#f87171",
                500: "#ff4500",
                600: "#dc2626",
                700: "#b91c1c",
                800: "#991b1b",
                900: "#7f1d1d",
              },
              dark: {
                50: "#f8fafc",
                100: "#f1f5f9",
                200: "#e2e8f0",
                300: "#cbd5e1",
                400: "#94a3b8",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1e293b",
                900: "#0f172a",
                950: "#020617",
              },
              accent: {
                50: "#ecfdf5",
                100: "#d1fae5",
                200: "#a7f3d0",
                300: "#6ee7b7",
                400: "#34d399",
                500: "#10b981",
                600: "#059669",
                700: "#047857",
                800: "#065f46",
                900: "#064e3b",
              },
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            animation: {
              "fade-in": "fadeIn 0.6s ease-out",
              "slide-up": "slideUp 0.4s ease-out",
              "slide-down": "slideDown 0.4s ease-out",
              "scale-in": "scaleIn 0.3s ease-out",
              glow: "glow 2s ease-in-out infinite alternate",
              shimmer: "shimmer 2s linear infinite",
              "bounce-gentle": "bounceGentle 2s infinite",
              "pulse-soft":
                "pulseSoft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              float: "float 3s ease-in-out infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              slideUp: {
                "0%": { transform: "translateY(100%)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              slideDown: {
                "0%": { transform: "translateY(-100%)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              scaleIn: {
                "0%": { transform: "scale(0.9)", opacity: "0" },
                "100%": { transform: "scale(1)", opacity: "1" },
              },
              glow: {
                "0%": { boxShadow: "0 0 5px rgba(255, 69, 0, 0.3)" },
                "100%": { boxShadow: "0 0 20px rgba(255, 69, 0, 0.6)" },
              },
              shimmer: {
                "0%": { backgroundPosition: "-200% 0" },
                "100%": { backgroundPosition: "200% 0" },
              },
              bounceGentle: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-5px)" },
              },
              pulseSoft: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.8" },
              },
              float: {
                "0%, 100%": { transform: "translateY(0px)" },
                "50%": { transform: "translateY(-10px)" },
              },
            },
            backdropBlur: {
              xs: "2px",
            },
            boxShadow: {
              glow: "0 0 20px rgba(255, 69, 0, 0.2)",
              "glow-lg": "0 0 40px rgba(255, 69, 0, 0.3)",
              "inner-glow": "inset 0 0 20px rgba(255, 69, 0, 0.1)",
              "reddit-glow": "0 0 30px rgba(255, 69, 0, 0.3)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: linear-gradient(
          135deg,
          #0b1426 0%,
          #030a19 50%,
          #000000 100%
        );
        min-height: 100vh;
        color: #d7dadc;
      }

      .reddit-card {
        background: linear-gradient(135deg, #1a1a1b 0%, #1e1e1f 100%);
        border: 1px solid #343536;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .reddit-card:hover {
        border-color: #4f4f50;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transform: translateY(-1px);
      }

      .reddit-card-special {
        background: linear-gradient(135deg, #1a1a1b 0%, #1e1e1f 100%);
        border: 1px solid #ff4500;
        box-shadow: 0 0 20px rgba(255, 69, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .reddit-card-special:hover {
        border-color: #ff8700;
        box-shadow: 0 0 25px rgba(255, 69, 0, 0.2);
        transform: translateY(-2px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%);
        border: 1px solid #ff4500;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #ff6600 0%, #ff8700 100%);
        border-color: #ff6600;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border: 1px solid #343536;
        color: #d7dadc;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #2d2d2e 0%, #3d3d3e 100%);
        border-color: #4f4f50;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        border: 1px solid #dc2626;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
      }

      .tab-button {
        background: transparent;
        border: 1px solid transparent;
        color: #818384;
        transition: all 0.3s ease;
        position: relative;
      }

      .tab-button.active {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border-color: #ff4500;
        color: #ff4500;
        box-shadow: 0 2px 8px rgba(255, 69, 0, 0.2);
      }

      .tab-button:hover:not(.active) {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border-color: #343536;
        color: #d7dadc;
      }

      .status-badge {
        position: relative;
        overflow: hidden;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid;
      }

      .status-lost {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        border-color: #dc2626;
        color: white;
      }

      .status-found {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        border-color: #059669;
        color: white;
      }

      .status-active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-color: #3b82f6;
        color: white;
      }

      .status-claimed {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        border-color: #7c3aed;
        color: white;
      }

      .notification-item {
        background: linear-gradient(135deg, #1a1a1b 0%, #1e1e1f 100%);
        border: 1px solid #343536;
        transition: all 0.3s ease;
      }

      .notification-item:hover {
        border-color: #4f4f50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .notification-item.unread {
        background: linear-gradient(135deg, #2d1f1f 0%, #3d2b2b 100%);
        border-color: #ff4500;
      }

      .notification-badge {
        background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%);
        animation: pulse-soft 2s infinite;
      }

      .profile-avatar {
        box-shadow: 0 0 20px rgba(255, 69, 0, 0.3);
        border: 2px solid #ff4500;
      }

      .modal-backdrop {
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.9);
      }

      .loading-shimmer {
        background: linear-gradient(
          90deg,
          #1a1a1b 25%,
          #2d2d2e 50%,
          #1a1a1b 75%
        );
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
      }

      .message-bubble-sent {
        background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%);
        color: white;
        border: 1px solid #ff4500;
      }

      .message-bubble-received {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        color: #d7dadc;
        border: 1px solid #343536;
      }

      .contact-info-card {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(4, 120, 87, 0.05) 100%
        );
        border: 1px solid #059669;
      }

      .input-field {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border: 1px solid #343536;
        color: #d7dadc;
        transition: all 0.3s ease;
      }

      .input-field:focus {
        background: linear-gradient(135deg, #2d2d2e 0%, #3d3d3e 100%);
        border-color: #ff4500;
        box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        outline: none;
      }

      .input-field::placeholder {
        color: #818384;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #1a1a1b;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #ff6600 0%, #ff8700 100%);
      }

      .header-blur {
        backdrop-filter: blur(20px);
        background: rgba(11, 20, 38, 0.95);
        border-bottom: 1px solid #343536;
      }

      .floating-element {
        animation: float 3s ease-in-out infinite;
      }

      .gradient-text {
        background: linear-gradient(135deg, #d7dadc 0%, #ff4500 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .glow-on-hover {
        transition: all 0.3s ease;
      }

      .glow-on-hover:hover {
        box-shadow: 0 0 15px rgba(255, 69, 0, 0.2);
      }

      .answer-comparison {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border: 1px solid #343536;
        transition: all 0.3s ease;
      }

      .answer-correct {
        border-color: #059669;
        background: linear-gradient(
          135deg,
          rgba(5, 150, 105, 0.1) 0%,
          rgba(4, 120, 87, 0.05) 100%
        );
      }

      .answer-incorrect {
        border-color: #dc2626;
        background: linear-gradient(
          135deg,
          rgba(220, 38, 38, 0.1) 0%,
          rgba(153, 27, 27, 0.05) 100%
        );
      }

      .conversation-container {
        background: linear-gradient(135deg, #1a1a1b 0%, #1e1e1f 100%);
        border: 1px solid #343536;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .message-container {
        max-height: 60vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #ff4500 #1a1a1b;
        background: #0b1426;
      }

      .message-input-container {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border-top: 1px solid #343536;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border: 2px solid #ff4500;
        background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%);
        border-radius: 50%;
      }

      .analytics-card {
        background: linear-gradient(135deg, #1a1a1b 0%, #1e1e1f 100%);
        border: 1px solid #ff4500;
        box-shadow: 0 4px 20px rgba(255, 69, 0, 0.1);
      }

      .stats-number {
        color: #ff4500;
        font-weight: 800;
        text-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
      }

      .conversation-header {
        background: linear-gradient(135deg, #1a1a1b 0%, #2d2d2e 100%);
        border-bottom: 1px solid #343536;
      }

      .message-list {
        background: #0b1426;
        padding: 1rem;
      }

      .message-item {
        margin-bottom: 1rem;
        max-width: 70%;
      }

      .message-item.sent {
        margin-left: auto;
      }

      .message-item.received {
        margin-right: auto;
      }

      .message-content {
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
        position: relative;
      }

      .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
      }

      .message-input-area {
        padding: 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: end;
      }

      .message-input {
        flex: 1;
        background: #1a1a1b;
        border: 1px solid #343536;
        color: #d7dadc;
        padding: 0.75rem 1rem;
        border-radius: 20px;
        resize: none;
        max-height: 120px;
        min-height: 44px;
        transition: all 0.3s ease;
      }

      .message-input:focus {
        border-color: #ff4500;
        box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        outline: none;
      }

      .message-send-btn {
        background: #ff4500;
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .message-send-btn:hover {
        background: #ff6600;
        transform: translateY(-1px);
      }

      .message-send-btn:disabled {
        background: #4f4f50;
        cursor: not-allowed;
        transform: none;
      }
    </style>
  </head>
  <body class="bg-reddit-dark min-h-screen">
    <!-- Header -->
    <header
      id="header"
      class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
    >
      <div class="header-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <div
              class="flex items-center cursor-pointer hover:scale-105 transition-transform"
              onclick="goHome()"
            >
              <div
                class="w-10 h-10 bg-gradient-to-r from-reddit-orange to-reddit-upvote rounded-lg flex items-center justify-center mr-3 shadow-reddit-glow floating-element"
              >
                <span class="text-white font-bold text-lg">BUP</span>
              </div>
              <h1 class="text-xl font-bold gradient-text">Lost & Found</h1>
            </div>
            <nav class="flex items-center space-x-4">
              <button
                onclick="goHome()"
                class="btn-secondary px-6 py-2 rounded-lg font-medium transition-all duration-200"
              >
                <svg
                  class="w-5 h-5 inline mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                  ></path>
                </svg>
                Home
              </button>

              <button
                onclick="showUpdateProfile()"
                class="btn-secondary px-6 py-2 rounded-lg font-medium transition-all duration-200"
              >
                Update Profile
              </button>

              <button
                onclick="postItem()"
                class="btn-secondary px-6 py-2 rounded-lg font-medium transition-all duration-200"
              >
                Post Item
              </button>

              <button
                onclick="toggleNotifications()"
                class="relative p-2 text-reddit-text hover:text-reddit-orange transition-colors duration-200 glow-on-hover rounded-lg"
                id="notificationButton"
              >
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"
                  ></path>
                </svg>
                <span
                  id="notificationBadge"
                  class="absolute -top-1 -right-1 w-5 h-5 notification-badge text-white text-xs rounded-full flex items-center justify-center hidden"
                ></span>
              </button>

              <button
                onclick="logout()"
                class="btn-primary px-6 py-2 rounded-lg font-medium transition-all duration-200"
              >
                Logout
              </button>
            </nav>
          </div>
        </div>
      </div>

      <!-- Notification Dropdown -->
      <div
        id="notificationDropdown"
        class="absolute top-16 right-4 w-80 reddit-card rounded-lg shadow-2xl hidden z-50 max-h-96 overflow-y-auto"
      >
        <div class="p-4 border-b border-reddit-border">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-reddit-text">Notifications</h3>
            <button
              onclick="markAllNotificationsRead()"
              class="text-sm text-reddit-orange hover:text-reddit-upvote transition-colors"
            >
              Mark all read
            </button>
          </div>
        </div>
        <div id="notificationList" class="p-2"></div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Profile Header -->
        <div
          id="profileHeader"
          class="reddit-card-special rounded-lg p-8 mb-8 animate-fade-in"
        >
          <div
            class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8"
          >
            <div class="relative">
              <div
                class="w-32 h-32 rounded-full overflow-hidden bg-gradient-to-br from-reddit-orange to-reddit-upvote flex-shrink-0 shadow-2xl profile-avatar"
              >
                <img
                  id="profileImage"
                  src=""
                  alt="Profile"
                  class="w-full h-full object-cover"
                />
              </div>
              <div
                class="absolute -bottom-2 -right-2 w-8 h-8 bg-accent-500 rounded-full border-4 border-reddit-dark shadow-lg flex items-center justify-center animate-glow"
              >
                <div class="w-3 h-3 bg-white rounded-full"></div>
              </div>
            </div>
            <div class="flex-grow text-center md:text-left">
              <h2
                id="userName"
                class="text-3xl font-bold gradient-text mb-2"
              ></h2>
              <p id="userEmail" class="text-reddit-muted mb-2 text-lg"></p>
              <p
                id="userDepartment"
                class="text-sm text-reddit-text font-medium px-4 py-2 bg-reddit-orange/20 rounded-lg inline-block border border-reddit-orange/30"
              ></p>
            </div>
          </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="reddit-card rounded-lg mb-8">
          <nav class="flex overflow-x-auto p-2 space-x-2">
            <button
              onclick="switchTab('posted')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="posted"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                  <path
                    fill-rule="evenodd"
                    d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span>Posted Items</span>
              </span>
            </button>
            <button
              onclick="switchTab('claimed')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="claimed"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span>Claimed Items</span>
              </span>
            </button>
            <button
              onclick="switchTab('comments')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="comments"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span>My Comments</span>
              </span>
            </button>
            <button
              onclick="switchTab('suggestions')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="suggestions"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                  ></path>
                </svg>
                <span>My Suggestions</span>
              </span>
            </button>
            <button
              onclick="switchTab('messages')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="messages"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                  ></path>
                  <path
                    d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                  ></path>
                </svg>
                <span>Messages</span>
              </span>
            </button>
            <button
              onclick="switchTab('analytics')"
              class="tab-button flex-shrink-0 px-6 py-4 rounded-lg text-sm font-semibold whitespace-nowrap"
              data-tab="analytics"
            >
              <span class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                  ></path>
                </svg>
                <span>Analytics</span>
              </span>
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div id="tabContent" class="animate-fade-in">
          <div id="loadingState" class="flex justify-center items-center py-20">
            <div class="relative">
              <div
                class="animate-spin h-16 w-16 border-b-4 border-reddit-orange rounded-full"
              ></div>
              <div
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
              >
                <div
                  class="w-4 h-4 bg-reddit-orange rounded-full animate-glow"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Update Profile Modal -->
    <div
      id="updateProfileModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <h3 class="text-2xl font-bold mb-6 gradient-text">Update Profile</h3>
        <p class="text-reddit-muted mb-6 leading-relaxed">
          You will be redirected to the update profile page where you can modify
          your personal information.
        </p>
        <div class="flex gap-4">
          <button
            onclick="window.location.href='update-profile.html'"
            class="flex-1 btn-primary py-3 rounded-lg font-semibold"
          >
            Continue
          </button>
          <button
            onclick="hideUpdateProfile()"
            class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div
      id="editItemModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto shadow-2xl animate-scale-in"
      >
        <h3 class="text-2xl font-bold mb-6 gradient-text">Edit Item</h3>
        <form id="editItemForm" enctype="multipart/form-data">
          <input type="hidden" id="editItemId" />
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Title</label
              >
              <input
                type="text"
                id="editTitle"
                class="w-full input-field px-4 py-3 rounded-lg"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Description</label
              >
              <textarea
                id="editDescription"
                class="w-full input-field px-4 py-3 h-32 resize-none rounded-lg"
                required
              ></textarea>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Location</label
              >
              <input
                type="text"
                id="editLocation"
                class="w-full input-field px-4 py-3 rounded-lg"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Image (optional)</label
              >
              <input
                type="file"
                id="editImage"
                accept="image/*"
                class="w-full input-field px-4 py-3 rounded-lg"
              />
            </div>
            <div id="editValidityQuestionsSection" class="hidden">
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Validity Questions</label
              >
              <div id="editValidityQuestionsList" class="space-y-3"></div>
              <button
                type="button"
                onclick="addEditValidityQuestion()"
                class="mt-3 btn-secondary px-4 py-2 rounded-lg text-sm"
              >
                Add Question
              </button>
            </div>
          </div>
          <div class="flex gap-4 mt-8">
            <button
              type="submit"
              class="flex-1 btn-primary py-3 rounded-lg font-semibold"
            >
              Update Item
            </button>
            <button
              type="button"
              onclick="hideEditItem()"
              class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Requests Modal -->
    <div
      id="requestsModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-5xl w-full p-8 max-h-[90vh] overflow-y-auto shadow-2xl animate-scale-in"
      >
        <h3
          id="requestsModalTitle"
          class="text-2xl font-bold mb-6 gradient-text"
        >
          Requests
        </h3>
        <div id="requestsContent"></div>
        <button
          onclick="hideRequests()"
          class="mt-6 btn-secondary px-8 py-3 rounded-lg font-semibold"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Contact Info Modal -->
    <div
      id="contactInfoModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <h3 class="text-2xl font-bold mb-6 gradient-text">
          Provide Contact Information
        </h3>
        <form id="contactInfoForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Phone Number *</label
              >
              <input
                type="tel"
                id="contactPhone"
                class="w-full input-field px-4 py-3 rounded-lg"
                required
                placeholder="01XXXXXXXXX"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Alternate Phone</label
              >
              <input
                type="tel"
                id="contactAlternatePhone"
                class="w-full input-field px-4 py-3 rounded-lg"
                placeholder="01XXXXXXXXX"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Email</label
              >
              <input
                type="email"
                id="contactEmail"
                class="w-full input-field px-4 py-3 rounded-lg"
                placeholder="your.email@example.com"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Meeting Location</label
              >
              <input
                type="text"
                id="contactLocation"
                class="w-full input-field px-4 py-3 rounded-lg"
                placeholder="e.g., Library entrance, Cafeteria"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Preferred Meeting Time</label
              >
              <input
                type="text"
                id="contactTime"
                class="w-full input-field px-4 py-3 rounded-lg"
                placeholder="e.g., Tomorrow 2 PM, After 5 PM"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-reddit-text"
                >Additional Notes</label
              >
              <textarea
                id="contactNotes"
                class="w-full input-field px-4 py-3 h-24 resize-none rounded-lg"
                placeholder="Any additional information..."
              ></textarea>
            </div>
          </div>
          <div class="flex gap-4 mt-6">
            <button
              type="submit"
              class="flex-1 btn-primary py-3 rounded-lg font-semibold"
            >
              Approve & Share Contact
            </button>
            <button
              type="button"
              onclick="hideContactInfo()"
              class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Block User Modal -->
    <div
      id="blockUserModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <div
          class="flex items-center justify-center w-16 h-16 mx-auto mb-6 bg-red-500/20 rounded-lg border border-red-500"
        >
          <svg
            class="w-8 h-8 text-red-500"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-center mb-4 text-reddit-text">
          Block User
        </h3>
        <p id="blockUserMessage" class="text-reddit-muted text-center mb-6"></p>
        <div class="flex gap-4">
          <button
            id="confirmBlockButton"
            class="flex-1 btn-danger py-3 rounded-lg font-semibold"
          >
            Block User
          </button>
          <button
            onclick="hideBlockUser()"
            class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div
      id="deleteConfirmModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <div
          class="flex items-center justify-center w-16 h-16 mx-auto mb-6 bg-red-500/20 rounded-lg border border-red-500"
        >
          <svg
            class="w-8 h-8 text-red-500"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-center mb-4 text-reddit-text">
          Confirm Delete
        </h3>
        <p
          id="deleteConfirmMessage"
          class="text-reddit-muted text-center mb-6"
        ></p>
        <div class="flex gap-4">
          <button
            id="confirmDeleteButton"
            class="flex-1 btn-danger py-3 rounded-lg font-semibold"
          >
            Delete
          </button>
          <button
            onclick="hideDeleteConfirm()"
            class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Comment/Suggestion Modal -->
    <div
      id="editModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <h3 id="editModalTitle" class="text-2xl font-bold mb-6 gradient-text">
          Edit
        </h3>
        <textarea
          id="editContent"
          class="w-full input-field px-4 py-3 h-32 resize-none rounded-lg"
          required
          placeholder="Enter your content here..."
        ></textarea>
        <div class="flex gap-4 mt-6">
          <button
            onclick="saveEdit()"
            class="flex-1 btn-primary py-3 rounded-lg font-semibold"
          >
            Save Changes
          </button>
          <button
            onclick="hideEditModal()"
            class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div
      id="rejectionModal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4"
    >
      <div
        class="reddit-card rounded-lg max-w-md w-full p-8 shadow-2xl animate-scale-in"
      >
        <h3 class="text-2xl font-bold mb-6 gradient-text">Reject Request</h3>
        <textarea
          id="rejectionReason"
          class="w-full input-field px-4 py-3 h-32 resize-none rounded-lg"
          required
          placeholder="Please provide a reason for rejection..."
        ></textarea>
        <div class="flex gap-4 mt-6">
          <button
            onclick="submitRejection()"
            class="flex-1 btn-danger py-3 rounded-lg font-semibold"
          >
            Reject Request
          </button>
          <button
            onclick="hideRejectionModal()"
            class="flex-1 btn-secondary py-3 rounded-lg font-semibold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script>
      let currentUser = null;
      let currentTab = "posted";
      let editingType = null;
      let editingId = null;
      let lastScrollY = 0;
      let deleteCallback = null;
      let pendingRejection = null;
      let pendingApproval = null;
      let pendingBlock = null;
      let notificationPollingInterval = null;
      let editValidityQuestionCount = 0;

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        setupScrollListener();
        loadNotifications();
        startNotificationPolling();
      });

      // Check authentication
      function checkAuth() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        loadUserProfile();
      }

      // Setup scroll listener for header
      function setupScrollListener() {
        window.addEventListener("scroll", () => {
          const currentScrollY = window.scrollY;
          const header = document.getElementById("header");

          if (currentScrollY > lastScrollY && currentScrollY > 100) {
            header.style.transform = "translateY(-100%)";
            header.style.opacity = "0";
          } else {
            header.style.transform = "translateY(0)";
            header.style.opacity = "1";
          }
          lastScrollY = currentScrollY;
        });

        document.addEventListener("click", (e) => {
          const dropdown = document.getElementById("notificationDropdown");
          const button = document.getElementById("notificationButton");

          if (!dropdown.contains(e.target) && !button.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });
      }

      // Enhanced image creation with proper fallback
      function createImageWithFallback(
        src,
        alt,
        className = "",
        fallbackInitials = null
      ) {
        const img = document.createElement("img");
        img.className = className;
        img.alt = alt;

        const handleError = () => {
          if (fallbackInitials) {
            img.src = generateProfileInitials(
              fallbackInitials.firstName,
              fallbackInitials.lastName
            );
          } else {
            img.src =
              "data:image/svg+xml;base64," +
              btoa(`
              <svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="#ff4500"/>
                <text x="50" y="50" font-family="Arial" font-size="14" fill="white" text-anchor="middle" dy=".3em">No Image</text>
              </svg>
            `);
          }
        };

        img.onerror = handleError;

        if (src && src.trim()) {
          img.src = getFullImageUrl(src);
        } else {
          handleError();
        }

        return img;
      }

      // Load user profile
      async function loadUserProfile() {
        try {
          showToast("Loading profile...", "info");
          const response = await fetch("/api/users/me", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            currentUser = data.user;
            displayUserProfile(data.user);
            switchTab("posted");
          } else {
            throw new Error("Failed to load profile");
          }
        } catch (error) {
          showToast("Error loading profile. Please try again.", "error");
          console.error(error);
        }
      }

      // Display user profile
      function displayUserProfile(user) {
        document.getElementById(
          "userName"
        ).textContent = `${user.firstName} ${user.lastName}`;
        document.getElementById("userEmail").textContent = user.email;
        document.getElementById("userDepartment").textContent = user.department;

        const profileImg = document.getElementById("profileImage");
        const profileImageUrl = getProfileImageUrl(user);
        profileImg.src = profileImageUrl;
        profileImg.onerror = function () {
          this.src = generateProfileInitials(user.firstName, user.lastName);
        };
      }

      // Get profile image URL with proper fallback handling
      function getProfileImageUrl(user) {
        if (user.profileImage) {
          return user.profileImage.startsWith("http")
            ? user.profileImage
            : `${window.location.origin}${user.profileImage}`;
        }
        return generateProfileInitials(user.firstName, user.lastName);
      }

      // Generate profile initials as fallback
      function generateProfileInitials(firstName, lastName) {
        return `https://ui-avatars.com/api/?name=${encodeURIComponent(
          firstName
        )}+${encodeURIComponent(
          lastName
        )}&background=ff4500&color=fff&size=128&bold=true`;
      }

      // Get full image URL
      function getFullImageUrl(imagePath) {
        if (!imagePath) return null;
        if (imagePath.startsWith("http")) return imagePath;
        return `${window.location.origin}${imagePath}`;
      }

      // Notification System
      async function loadNotifications() {
        try {
          const response = await fetch("/api/notifications", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayNotifications(data.notifications);
            updateNotificationBadge(data.notifications);
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
        }
      }

      function displayNotifications(notifications) {
        const notificationList = document.getElementById("notificationList");

        if (!notifications || notifications.length === 0) {
          notificationList.innerHTML = `
            <div class="text-center py-8">
              <div class="w-16 h-16 mx-auto mb-4 bg-reddit-border/20 rounded-lg flex items-center justify-center">
                <svg class="w-8 h-8 text-reddit-muted" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                </svg>
              </div>
              <p class="text-reddit-muted">No notifications yet</p>
            </div>
          `;
          return;
        }

        notificationList.innerHTML = notifications
          .map(
            (notification) => `
            <div class="notification-item ${
              notification.read ? "" : "unread"
            } p-4 mb-2 cursor-pointer rounded-lg"
                 onclick="markNotificationAsRead('${notification._id}')">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                  ${getNotificationIcon(notification.type)}
                </div>
                <div class="flex-1 min-w-0">
                  <h4 class="text-sm font-semibold text-reddit-text truncate">${
                    notification.title
                  }</h4>
                  <p class="text-xs text-reddit-muted mt-1 leading-relaxed">${
                    notification.message
                  }</p>
                  <p class="text-xs text-reddit-muted mt-2">${formatTimeAgo(
                    notification.createdAt
                  )}</p>
                </div>
                ${
                  !notification.read
                    ? '<div class="w-2 h-2 bg-reddit-orange rounded-full flex-shrink-0"></div>'
                    : ""
                }
              </div>
            </div>
          `
          )
          .join("");
      }

      function getNotificationIcon(type) {
        const iconClasses = "w-6 h-6";
        switch (type) {
          case "claim_request_submitted":
          case "inform_request_submitted":
            return `<svg class="${iconClasses} text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                      <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"></path>
                    </svg>`;
          case "claim_request_approved":
          case "inform_request_approved":
            return `<svg class="${iconClasses} text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>`;
          case "claim_request_rejected":
          case "inform_request_rejected":
            return `<svg class="${iconClasses} text-red-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>`;
          default:
            return `<svg class="${iconClasses} text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                    </svg>`;
        }
      }

      function updateNotificationBadge(notifications) {
        const badge = document.getElementById("notificationBadge");
        const unreadCount = notifications.filter((n) => !n.read).length;

        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? "99+" : unreadCount;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      }

      function toggleNotifications() {
        const dropdown = document.getElementById("notificationDropdown");
        dropdown.classList.toggle("hidden");

        if (!dropdown.classList.contains("hidden")) {
          loadNotifications();
        }
      }

      async function markNotificationAsRead(notificationId) {
        try {
          await fetch(`/api/notifications/${notificationId}/read`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          loadNotifications();
        } catch (error) {
          console.error("Error marking notification as read:", error);
        }
      }

      async function markAllNotificationsRead() {
        try {
          await fetch("/api/notifications/mark-all-read", {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          loadNotifications();
          showToast("All notifications marked as read", "success");
        } catch (error) {
          console.error("Error marking all notifications as read:", error);
          showToast("Error marking notifications as read", "error");
        }
      }

      function startNotificationPolling() {
        notificationPollingInterval = setInterval(() => {
          loadNotifications();
        }, 30000);
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return "Just now";
        if (diffInSeconds < 3600)
          return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400)
          return `${Math.floor(diffInSeconds / 3600)}h ago`;
        return `${Math.floor(diffInSeconds / 86400)}d ago`;
      }

      // Switch tabs
      function switchTab(tab) {
        currentTab = tab;

        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
        if (activeBtn) {
          activeBtn.classList.add("active");
        }

        loadTabContent(tab);
      }

      // Load tab content
      async function loadTabContent(tab) {
        const container = document.getElementById("tabContent");
        container.innerHTML = `
          <div class="flex justify-center items-center py-20">
            <div class="relative">
              <div class="animate-spin h-16 w-16 border-b-4 border-reddit-orange rounded-full"></div>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <div class="w-4 h-4 bg-reddit-orange rounded-full animate-glow"></div>
              </div>
            </div>
          </div>
        `;

        try {
          switch (tab) {
            case "posted":
              await loadPostedItems();
              break;
            case "claimed":
              await loadClaimedItems();
              break;
            case "comments":
              await loadComments();
              break;
            case "suggestions":
              await loadSuggestions();
              break;
            case "messages":
              await loadMessages();
              break;
            case "analytics":
              await loadAnalytics();
              break;
          }
        } catch (error) {
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-lg border border-red-500 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-red-500 mb-2">Error Loading Content</h3>
              <p class="text-reddit-muted">Please try refreshing the page</p>
            </div>
          `;
          showToast("Error loading content. Please try again.", "error");
        }
      }

      // Load posted items
      async function loadPostedItems() {
        const response = await fetch("/api/items?postedBy=me", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        const data = await response.json();
        const container = document.getElementById("tabContent");

        if (data.items && data.items.length > 0) {
          container.innerHTML = `
            <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
              ${data.items
                .map(
                  (item) => `
                  <div class="reddit-card rounded-lg overflow-hidden glow-on-hover">
                    <div class="relative">
                      ${
                        item.image
                          ? `<img src="${getFullImageUrl(item.image)}" alt="${
                              item.title
                            }" class="w-full h-56 object-cover" onerror="this.src='data:image/svg+xml;base64,' + btoa('<svg width=\\'100\\' height=\\'100\\' xmlns=\\'http://www.w3.org/2000/svg\\'><rect width=\\'100\\' height=\\'100\\' fill=\\'#ff4500\\'/><text x=\\'50\\' y=\\'50\\' font-family=\\'Arial\\' font-size=\\'14\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'>No Image</text></svg>')">`
                          : `<div class="w-full h-56 bg-gradient-to-br from-reddit-dark to-reddit-darker flex items-center justify-center border border-reddit-border">
                              <svg class="w-16 h-16 text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                              </svg>
                            </div>`
                      }
                      <div class="absolute top-4 left-4 flex space-x-2">
                        <span class="status-badge px-3 py-1 text-xs font-bold rounded-lg ${
                          item.type === "lost" ? "status-lost" : "status-found"
                        }">${item.type.toUpperCase()}</span>
                        <span class="status-badge px-3 py-1 text-xs font-bold rounded-lg ${getStatusClass(
                          item.status
                        )}">${item.status.toUpperCase()}</span>
                      </div>
                    </div>
                    <div class="p-6">
                      <h3 class="font-bold text-xl mb-3 text-reddit-text">${
                        item.title
                      }</h3>
                      <p class="text-reddit-muted text-sm mb-3 line-clamp-2">${
                        item.description
                      }</p>
                      <div class="flex items-center text-reddit-muted text-sm mb-4">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        ${item.location}
                      </div>
                      <div class="flex gap-2">
                        <button onclick="editItem('${
                          item._id
                        }')" class="flex-1 btn-secondary text-white py-2 px-4 rounded-lg text-sm font-medium">
                          Edit
                        </button>
                        ${getRequestButtonsForItem(item)}
                        <button onclick="confirmDelete('item', '${
                          item._id
                        }', '${
                    item.title
                  }')" class="btn-danger py-2 px-4 rounded-lg text-sm font-medium">
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-24 h-24 mx-auto mb-6 bg-reddit-orange/20 rounded-lg border border-reddit-orange flex items-center justify-center floating-element">
                <svg class="w-12 h-12 text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-reddit-text mb-2">No Items Posted Yet</h3>
              <p class="text-reddit-muted mb-6">Start by posting your first lost or found item</p>
              <button onclick="window.location.href='post-item.html'" class="btn-primary px-8 py-3 rounded-lg font-semibold">
                Post an Item
              </button>
            </div>
          `;
        }
      }

      // Get request buttons for item based on type and requests
      function getRequestButtonsForItem(item) {
        let buttons = "";

        if (
          item.type === "found" &&
          item.claimRequests &&
          item.claimRequests.length > 0
        ) {
          buttons += `<button onclick="viewRequests('${item._id}', 'claim')" class="flex-1 btn-primary text-white py-2 px-4 rounded-lg text-sm font-medium">
                        Claims (${item.claimRequests.length})
                      </button>`;
        }

        if (
          item.type === "lost" &&
          item.informRequests &&
          item.informRequests.length > 0
        ) {
          buttons += `<button onclick="viewRequests('${item._id}', 'inform')" class="flex-1 btn-primary text-white py-2 px-4 rounded-lg text-sm font-medium">
                        Info (${item.informRequests.length})
                      </button>`;
        }

        return buttons;
      }

      // Load claimed items
      async function loadClaimedItems() {
        try {
          const response = await fetch("/api/items/my-claimed", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          const data = await response.json();
          const container = document.getElementById("tabContent");

          if (data.items && data.items.length > 0) {
            container.innerHTML = `
              <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                ${data.items
                  .map((item) => {
                    let claimDetails = null;

                    if (!currentUser || !currentUser._id) {
                      console.error("Current user not loaded properly");
                      return "";
                    }

                    if (item.type === "found" && item.claimRequests) {
                      const approvedClaim = item.claimRequests.find(
                        (req) =>
                          req &&
                          req.status === "approved" &&
                          req.requestedBy &&
                          req.requestedBy._id &&
                          req.requestedBy._id.toString() ===
                            currentUser._id.toString()
                      );

                      if (approvedClaim) {
                        claimDetails = {
                          claimDate: approvedClaim.reviewedAt,
                          claimType: "claim_approved",
                          originalPoster: item.postedBy,
                          contactInfo: approvedClaim.contactInfo,
                        };
                      }
                    } else if (item.type === "lost" && item.informRequests) {
                      const approvedInform = item.informRequests.find(
                        (req) =>
                          req &&
                          req.status === "approved" &&
                          req.informedBy &&
                          req.informedBy._id &&
                          req.informedBy._id.toString() ===
                            currentUser._id.toString()
                      );

                      if (approvedInform) {
                        claimDetails = {
                          claimDate: approvedInform.reviewedAt,
                          claimType: "inform_approved",
                          originalPoster: item.postedBy,
                          contactInfo: approvedInform.contactInfo,
                        };
                      }
                    }

                    return `
                      <div class="reddit-card rounded-lg overflow-hidden glow-on-hover">
                        <div class="relative">
                          ${
                            item.image
                              ? `<img src="${getFullImageUrl(
                                  item.image
                                )}" alt="${
                                  item.title
                                }" class="w-full h-56 object-cover" onerror="this.src='data:image/svg+xml;base64,' + btoa('<svg width=\\'100\\' height=\\'100\\' xmlns=\\'http://www.w3.org/2000/svg\\'><rect width=\\'100\\' height=\\'100\\' fill=\\'#ff4500\\'/><text x=\\'50\\' y=\\'50\\' font-family=\\'Arial\\' font-size=\\'14\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'>No Image</text></svg>')">`
                              : `<div class="w-full h-56 bg-gradient-to-br from-reddit-dark to-reddit-darker flex items-center justify-center border border-reddit-border">
                                  <svg class="w-16 h-16 text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                  </svg>
                                </div>`
                          }
                          <div class="absolute top-4 left-4 flex space-x-2">
                            <span class="status-badge px-3 py-1 text-xs font-bold rounded-lg ${
                              item.type === "lost"
                                ? "status-lost"
                                : "status-found"
                            }">${item.type.toUpperCase()}</span>
                            <span class="status-badge px-3 py-1 text-xs font-bold rounded-lg status-claimed">CLAIMED</span>
                            ${
                              claimDetails && claimDetails.claimDate
                                ? `<span class="status-badge px-3 py-1 text-xs font-bold rounded-lg bg-blue-500/20 text-blue-400 border border-blue-500/30">
                                     ${new Date(
                                       claimDetails.claimDate
                                     ).toLocaleDateString("en-US", {
                                       month: "short",
                                       day: "numeric",
                                     })}
                                   </span>`
                                : ""
                            }
                          </div>
                        </div>
                        <div class="p-6">
                          <h3 class="font-bold text-xl mb-3 text-reddit-text">${
                            item.title
                          }</h3>
                          <p class="text-reddit-muted text-sm mb-3 line-clamp-2">${
                            item.description
                          }</p>
                          <div class="flex items-center text-reddit-muted text-sm mb-3">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            ${item.location}
                          </div>

                          ${
                            claimDetails
                              ? `
                            <div class="bg-accent-500/10 rounded-lg border border-accent-500/30 p-4 mb-4">
                              <div class="flex items-center space-x-2 mb-2">
                                <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-accent-400 font-semibold text-sm">
                                  ${
                                    claimDetails.claimType === "claim_approved"
                                      ? "Successfully Claimed"
                                      : "Successfully Reunited"
                                  }
                                </span>
                              </div>
                              ${
                                claimDetails.claimDate
                                  ? `<p class="text-xs text-reddit-muted">
                                       Claimed on ${new Date(
                                         claimDetails.claimDate
                                       ).toLocaleDateString("en-US", {
                                         year: "numeric",
                                         month: "long",
                                         day: "numeric",
                                         hour: "2-digit",
                                         minute: "2-digit",
                                       })}
                                     </p>`
                                  : ""
                              }
                            </div>
                          `
                              : ""
                          }

                          <div class="flex items-center space-x-2 text-sm text-reddit-muted mb-4">
                            <div class="w-6 h-6 rounded-full overflow-hidden bg-reddit-orange">
                              <img src="${getProfileImageUrl(
                                item.postedBy
                              )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                      item.postedBy.firstName,
                      item.postedBy.lastName
                    )}'">
                            </div>
                            <span>
                              ${
                                item.type === "found" ? "Found by" : "Posted by"
                              }: ${item.postedBy.firstName} ${
                      item.postedBy.lastName
                    }
                            </span>
                          </div>

                          <div class="flex gap-2">
                            <button onclick="viewContactInfo('${
                              item._id
                            }')" class="flex-1 btn-primary py-2 px-4 rounded-lg text-sm font-medium">
                              View Contact Info
                            </button>
                            ${
                              claimDetails && claimDetails.contactInfo
                                ? `<button onclick="showClaimDetailsModal('${
                                    item._id
                                  }', ${JSON.stringify(claimDetails).replace(
                                    /"/g,
                                    "&quot;"
                                  )})" class="btn-secondary py-2 px-4 rounded-lg text-sm font-medium">
                                     Details
                                   </button>`
                                : ""
                            }
                          </div>
                        </div>
                      </div>
                    `;
                  })
                  .join("")}
              </div>
            `;
          } else {
            container.innerHTML = `
              <div class="text-center py-20">
                <div class="w-24 h-24 mx-auto mb-6 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center floating-element">
                  <svg class="w-12 h-12 text-accent-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-semibold text-reddit-text mb-2">No Items Claimed Yet</h3>
                <p class="text-reddit-muted mb-6">Items you've successfully claimed will appear here</p>
                <button onclick="window.location.href='home.html'" class="btn-primary px-8 py-3 rounded-lg font-semibold">
                  Browse Items
                </button>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error loading claimed items:", error);
          const container = document.getElementById("tabContent");
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-lg border border-red-500 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-red-500 mb-2">Error Loading Claimed Items</h3>
              <p class="text-reddit-muted">Please try refreshing the page</p>
            </div>
          `;
          showToast("Error loading claimed items. Please try again.", "error");
        }
      }

      // Show claim details modal
      function showClaimDetailsModal(itemId, claimDetails) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4";
        modal.innerHTML = `
          <div class="reddit-card rounded-lg max-w-lg w-full p-8 shadow-2xl animate-scale-in">
            <h3 class="text-2xl font-bold mb-6 gradient-text">
              Claim Details
            </h3>
            <div class="contact-info-card rounded-lg p-6 mb-6">
              <div class="space-y-4">
                <div class="text-center mb-4">
                  <div class="w-16 h-16 mx-auto mb-3 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                    <svg class="w-8 h-8 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <h4 class="text-lg font-bold text-accent-400">
                    ${
                      claimDetails.claimType === "claim_approved"
                        ? "Item Successfully Claimed!"
                        : "Item Successfully Reunited!"
                    }
                  </h4>
                  ${
                    claimDetails.claimDate
                      ? `<p class="text-sm text-reddit-muted mt-2">
                           Approved on ${new Date(
                             claimDetails.claimDate
                           ).toLocaleDateString("en-US", {
                             year: "numeric",
                             month: "long",
                             day: "numeric",
                             hour: "2-digit",
                             minute: "2-digit",
                           })}
                         </p>`
                      : ""
                  }
                </div>

                ${
                  claimDetails.originalPoster
                    ? `
                  <div class="flex items-center space-x-3 p-3 bg-reddit-dark/50 rounded-lg">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-reddit-orange">
                      <img src="${getProfileImageUrl(
                        claimDetails.originalPoster
                      )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                        claimDetails.originalPoster.firstName,
                        claimDetails.originalPoster.lastName
                      )}'">
                    </div>
                    <div>
                      <p class="font-medium text-reddit-text">
                        ${
                          claimDetails.claimType === "claim_approved"
                            ? "Found by"
                            : "Owner"
                        }
                      </p>
                      <p class="text-sm text-reddit-muted">
                        ${claimDetails.originalPoster.firstName} ${
                        claimDetails.originalPoster.lastName
                      }
                      </p>
                    </div>
                  </div>
                `
                    : ""
                }
              </div>
            </div>
            <button onclick="this.closest('.modal-backdrop').remove()" class="w-full btn-primary py-3 rounded-lg font-semibold">
              Close
            </button>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Load comments
      async function loadComments() {
        const response = await fetch("/api/comments?postedBy=me", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        const data = await response.json();
        const container = document.getElementById("tabContent");

        if (data.comments && data.comments.length > 0) {
          container.innerHTML = `
            <div class="space-y-6">
              ${data.comments
                .map(
                  (comment) => `
                  <div class="reddit-card rounded-lg p-6 glow-on-hover">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                          <div class="w-10 h-10 rounded-full overflow-hidden bg-reddit-orange">
                            <img src="${getProfileImageUrl(
                              comment.postedBy
                            )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                    comment.postedBy.firstName,
                    comment.postedBy.lastName
                  )}'">
                          </div>
                          <div>
                            <p class="font-semibold text-reddit-text">${
                              comment.postedBy.firstName
                            } ${comment.postedBy.lastName}</p>
                            <p class="text-xs text-reddit-muted">${new Date(
                              comment.createdAt
                            ).toLocaleDateString("en-US", {
                              year: "numeric",
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })}</p>
                          </div>
                        </div>
                        <p class="text-reddit-text mb-3 leading-relaxed">${
                          comment.content
                        }</p>
                        <div class="inline-flex items-center px-3 py-1 bg-blue-500/20 text-blue-400 text-sm rounded-lg border border-blue-500/30">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"></path>
                          </svg>
                          On item: ${comment.item.title}
                        </div>
                      </div>
                      <div class="flex gap-3 ml-4">
                        <button onclick="editComment('${
                          comment._id
                        }', '${comment.content.replace(
                    /'/g,
                    "\\'"
                  )}' )" class="text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 p-2 rounded-lg transition-all duration-200">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                          </svg>
                        </button>
                        <button onclick="confirmDelete('comment', '${
                          comment._id
                        }', 'this comment')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 p-2 rounded-lg transition-all duration-200">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-24 h-24 mx-auto mb-6 bg-blue-500/20 rounded-lg border border-blue-500 flex items-center justify-center floating-element">
                <svg class="w-12 h-12 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-reddit-text mb-2">No Comments Yet</h3>
              <p class="text-reddit-muted mb-6">Your comments on items will appear here</p>
              <button onclick="window.location.href='home.html'" class="btn-primary px-8 py-3 rounded-lg font-semibold">
                Browse Items
              </button>
            </div>
          `;
        }
      }

      // Load suggestions
      async function loadSuggestions() {
        const response = await fetch("/api/suggestions?postedBy=me", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        const data = await response.json();
        const container = document.getElementById("tabContent");

        if (data.suggestions && data.suggestions.length > 0) {
          container.innerHTML = `
            <div class="space-y-6">
              ${data.suggestions
                .map(
                  (suggestion) => `
                  <div class="reddit-card rounded-lg p-6 glow-on-hover">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                          <div class="w-10 h-10 rounded-full overflow-hidden bg-reddit-orange">
                            <img src="${getProfileImageUrl(
                              suggestion.postedBy
                            )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                    suggestion.postedBy.firstName,
                    suggestion.postedBy.lastName
                  )}'">
                          </div>
                          <div>
                            <p class="font-semibold text-reddit-text">${
                              suggestion.postedBy.firstName
                            } ${suggestion.postedBy.lastName}</p>
                            <p class="text-xs text-reddit-muted">${new Date(
                              suggestion.createdAt
                            ).toLocaleDateString("en-US", {
                              year: "numeric",
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })}</p>
                          </div>
                        </div>
                        <p class="text-reddit-text leading-relaxed">${
                          suggestion.content
                        }</p>
                      </div>
                      <div class="flex gap-3 ml-4">
                        <button onclick="editSuggestion('${
                          suggestion._id
                        }', '${suggestion.content.replace(
                    /'/g,
                    "\\'"
                  )}' )" class="text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 p-2 rounded-lg transition-all duration-200">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                          </svg>
                        </button>
                        <button onclick="confirmDelete('suggestion', '${
                          suggestion._id
                        }', 'this suggestion')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 p-2 rounded-lg transition-all duration-200">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-24 h-24 mx-auto mb-6 bg-reddit-orange/20 rounded-lg border border-reddit-orange flex items-center justify-center floating-element">
                <svg class="w-12 h-12 text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-reddit-text mb-2">No Suggestions Yet</h3>
              <p class="text-reddit-muted mb-6">Your suggestions for improving the platform will appear here</p>
              <button onclick="window.location.href='home.html'" class="btn-primary px-8 py-3 rounded-lg font-semibold">
                Go to Home
              </button>
            </div>
          `;
        }
      }

      // Enhanced Messages Loading with Better UI and Fixed Image Loading
      async function loadMessages() {
        const response = await fetch("/api/messages", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        const data = await response.json();
        const container = document.getElementById("tabContent");

        if (data.messages && data.messages.length > 0) {
          const filteredMessages = data.messages.filter(
            (message) => message.sender._id !== message.receiver._id
          );

          if (filteredMessages.length > 0) {
            const conversations = {};
            filteredMessages.forEach((message) => {
              const otherUserId =
                message.sender._id === currentUser._id
                  ? message.receiver._id
                  : message.sender._id;
              const otherUser =
                message.sender._id === currentUser._id
                  ? message.receiver
                  : message.sender;

              if (!conversations[otherUserId]) {
                conversations[otherUserId] = {
                  user: otherUser,
                  messages: [],
                  lastMessage: null,
                  unreadCount: 0,
                };
              }
              conversations[otherUserId].messages.push(message);

              if (
                !conversations[otherUserId].lastMessage ||
                new Date(message.createdAt) >
                  new Date(conversations[otherUserId].lastMessage.createdAt)
              ) {
                conversations[otherUserId].lastMessage = message;
              }

              if (message.receiver._id === currentUser._id && !message.read) {
                conversations[otherUserId].unreadCount++;
              }
            });

            const sortedConversations = Object.values(conversations).sort(
              (a, b) =>
                new Date(b.lastMessage.createdAt) -
                new Date(a.lastMessage.createdAt)
            );

            container.innerHTML = `
              <div class="space-y-4">
                ${sortedConversations
                  .map(
                    (conversation) => `
                    <div class="reddit-card rounded-lg p-6 cursor-pointer glow-on-hover hover:border-reddit-orange/50 transition-all duration-300" onclick="openConversation('${
                      conversation.user._id
                    }', '${conversation.user.firstName} ${
                      conversation.user.lastName
                    }')">
                      <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                          <div class="relative">
                            <div class="user-avatar overflow-hidden">
                              <img src="${getProfileImageUrl(
                                conversation.user
                              )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                      conversation.user.firstName,
                      conversation.user.lastName
                    )}'">
                            </div>
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-accent-500 rounded-full border-2 border-reddit-dark animate-pulse-soft"></div>
                          </div>
                          <div class="flex-1">
                            <h4 class="font-bold text-lg text-reddit-text">${
                              conversation.user.firstName
                            } ${conversation.user.lastName}</h4>
                            <p class="text-sm text-reddit-muted">${
                              conversation.user.department
                            }</p>
                            <p class="text-xs text-reddit-muted mt-1">
                              Last active: ${formatTimeAgo(
                                conversation.lastMessage.createdAt
                              )}
                            </p>
                          </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                          ${
                            conversation.unreadCount > 0
                              ? `<div class="notification-badge w-6 h-6 text-white text-xs rounded-full flex items-center justify-center">
                                   ${
                                     conversation.unreadCount > 99
                                       ? "99+"
                                       : conversation.unreadCount
                                   }
                                 </div>`
                              : ""
                          }
                          ${
                            conversation.user._id !== currentUser._id
                              ? `<button onclick="event.stopPropagation(); confirmBlockUser('${conversation.user._id}', '${conversation.user.firstName} ${conversation.user.lastName}')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 p-2 rounded-lg transition-all duration-200">
                                   <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                     <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
                                   </svg>
                                 </button>`
                              : ""
                          }
                        </div>
                      </div>

                      <div class="bg-reddit-dark/50 rounded-lg p-3 border border-reddit-border/50">
                        <div class="flex items-start space-x-2">
                          <div class="w-6 h-6 rounded-full overflow-hidden bg-reddit-orange flex-shrink-0">
                            <img src="${getProfileImageUrl(
                              conversation.lastMessage.sender
                            )}" alt="Sender" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                      conversation.lastMessage.sender.firstName,
                      conversation.lastMessage.sender.lastName
                    )}'">
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-reddit-text">
                              ${
                                conversation.lastMessage.sender._id ===
                                currentUser._id
                                  ? "You"
                                  : conversation.lastMessage.sender.firstName
                              }:
                            </p>
                            <p class="text-sm text-reddit-muted truncate">
                              ${conversation.lastMessage.content.substring(
                                0,
                                100
                              )}${
                      conversation.lastMessage.content.length > 100 ? "..." : ""
                    }
                            </p>
                          </div>
                        </div>
                      </div>

                      <div class="mt-3 flex items-center justify-between text-xs text-reddit-muted">
                        <span>${conversation.messages.length} message${
                      conversation.messages.length !== 1 ? "s" : ""
                    }</span>
                        <span>Click to view conversation</span>
                      </div>
                    </div>
                  `
                  )
                  .join("")}
              </div>
            `;
          } else {
            container.innerHTML = getNoMessagesTemplate();
          }
        } else {
          container.innerHTML = getNoMessagesTemplate();
        }
      }

      // Enhanced conversation interface with better image handling
      function openConversation(userId, userName) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4";
        modal.innerHTML = `
          <div class="conversation-container max-w-4xl w-full h-[80vh] rounded-lg shadow-2xl animate-scale-in flex flex-col">
            <div class="conversation-header flex items-center justify-between p-6 rounded-t-lg">
              <h3 class="text-xl font-bold text-reddit-text">Conversation with ${userName}</h3>
              <button onclick="this.closest('.modal-backdrop').remove()" class="text-reddit-muted hover:text-reddit-text p-2 hover:bg-reddit-darker rounded-lg transition-all duration-200">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            <div id="conversationMessages" class="message-container flex-1 overflow-y-auto">
              <div class="flex justify-center items-center py-8">
                <div class="animate-spin h-8 w-8 border-b-2 border-reddit-orange rounded-full"></div>
              </div>
            </div>
            <div class="message-input-container rounded-b-lg">
              <div class="message-input-area">
                <textarea
                  id="newMessageInput"
                  placeholder="Type your message..."
                  class="message-input"
                  rows="1"
                  onkeypress="handleMessageKeyPress(event, '${userId}')"
                  oninput="autoResizeTextarea(this)"
                ></textarea>
                <button
                  onclick="sendMessage('${userId}')"
                  class="message-send-btn"
                  id="sendButton"
                >
                  Send
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        loadConversationMessages(userId);

        setTimeout(() => {
          document.getElementById("newMessageInput").focus();
        }, 100);
      }

      // Enhanced conversation message loading with proper image handling
      async function loadConversationMessages(userId) {
        try {
          const response = await fetch(`/api/messages?userId=${userId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          const data = await response.json();
          const container = document.getElementById("conversationMessages");

          if (data.messages && data.messages.length > 0) {
            container.innerHTML = `
              <div class="message-list">
                ${data.messages
                  .map(
                    (message) => `
                  <div class="message-item ${
                    message.sender._id === currentUser._id ? "sent" : "received"
                  }">
                    <div class="flex items-start space-x-2 ${
                      message.sender._id === currentUser._id
                        ? "flex-row-reverse space-x-reverse"
                        : ""
                    }">
                      <div class="user-avatar overflow-hidden flex-shrink-0">
                        <img src="${getProfileImageUrl(
                          message.sender
                        )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
                      message.sender.firstName,
                      message.sender.lastName
                    )}'">
                      </div>
                      <div class="flex flex-col ${
                        message.sender._id === currentUser._id
                          ? "items-end"
                          : "items-start"
                      }">
                        <div class="message-content ${
                          message.sender._id === currentUser._id
                            ? "message-bubble-sent"
                            : "message-bubble-received"
                        }">
                          <p class="text-sm leading-relaxed">${
                            message.content
                          }</p>
                        </div>
                        <div class="message-time ${
                          message.sender._id === currentUser._id
                            ? "text-right"
                            : "text-left"
                        }">
                          ${new Date(message.createdAt).toLocaleString(
                            "en-US",
                            {
                              month: "short",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            }
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            `;

            container.scrollTop = container.scrollHeight;
          } else {
            container.innerHTML = `
              <div class="message-list">
                <div class="text-center py-8">
                  <p class="text-reddit-muted">No messages yet. Start the conversation!</p>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error loading conversation:", error);
          document.getElementById("conversationMessages").innerHTML = `
            <div class="message-list">
              <div class="text-center py-8">
                <p class="text-red-400">Error loading messages</p>
              </div>
            </div>
          `;
        }
      }

      function handleMessageKeyPress(event, userId) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage(userId);
        }
      }

      function autoResizeTextarea(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
      }

      async function sendMessage(userId) {
        const input = document.getElementById("newMessageInput");
        const sendButton = document.getElementById("sendButton");
        const content = input.value.trim();

        if (!content) return;

        // Disable send button to prevent double sending
        sendButton.disabled = true;
        sendButton.textContent = "Sending...";

        try {
          const response = await fetch("/api/messages", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              receiver: userId,
              content: content,
            }),
          });

          if (response.ok) {
            input.value = "";
            input.style.height = "auto";
            loadConversationMessages(userId);
            showToast("Message sent!", "success");
          } else {
            throw new Error("Failed to send message");
          }
        } catch (error) {
          showToast("Error sending message. Please try again.", "error");
        } finally {
          sendButton.disabled = false;
          sendButton.textContent = "Send";
        }
      }

      function getNoMessagesTemplate() {
        return `
          <div class="text-center py-20">
            <div class="w-24 h-24 mx-auto mb-6 bg-blue-500/20 rounded-lg border border-blue-500 flex items-center justify-center floating-element">
              <svg class="w-12 h-12 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-reddit-text mb-2">No Messages Yet</h3>
            <p class="text-reddit-muted mb-6">Your conversations will appear here</p>
            <button onclick="window.location.href='home.html'" class="btn-primary px-8 py-3 rounded-lg font-semibold">
              Browse Items
            </button>
          </div>
        `;
      }

      // Load analytics data
      async function loadAnalytics() {
        try {
          const [statsResponse, analyticsResponse] = await Promise.all([
            fetch("/api/stats", {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }),
            fetch("/api/analytics/overview", {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }),
          ]);

          const statsData = await statsResponse.json();
          const analyticsData = await analyticsResponse.json();

          const container = document.getElementById("tabContent");

          container.innerHTML = `
            <div class="space-y-8">
              <!-- Personal Stats -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="analytics-card rounded-lg p-6">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-reddit-muted">Lost Items</p>
                      <p class="stats-number text-3xl font-bold">${
                        statsData.stats.lostCount
                      }</p>
                    </div>
                    <div class="w-12 h-12 bg-red-500/20 rounded-lg border border-red-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div class="analytics-card rounded-lg p-6">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-reddit-muted">Found Items</p>
                      <p class="stats-number text-3xl font-bold">${
                        statsData.stats.foundCount
                      }</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/20 rounded-lg border border-green-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div class="analytics-card rounded-lg p-6">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-reddit-muted">Reunited Items</p>
                      <p class="stats-number text-3xl font-bold">${
                        statsData.stats.reunitedCount
                      }</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg border border-purple-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div class="analytics-card rounded-lg p-6">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-reddit-muted">My Claims</p>
                      <p class="stats-number text-3xl font-bold">${
                        statsData.stats.myClaimedCount
                      }</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg border border-blue-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              <!-- System Overview -->
              <div class="analytics-card rounded-lg p-8">
                <h3 class="text-xl font-bold mb-6 gradient-text">System Overview</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <div class="text-center">
                    <p class="stats-number text-2xl font-bold">${
                      analyticsData.analytics.totalUsers
                    }</p>
                    <p class="text-sm text-reddit-muted">Total Users</p>
                  </div>
                  <div class="text-center">
                    <p class="stats-number text-2xl font-bold">${
                      analyticsData.analytics.totalItems
                    }</p>
                    <p class="text-sm text-reddit-muted">Total Items</p>
                  </div>
                  <div class="text-center">
                    <p class="stats-number text-2xl font-bold">${
                      analyticsData.analytics.totalComments
                    }</p>
                    <p class="text-sm text-reddit-muted">Total Comments</p>
                  </div>
                  <div class="text-center">
                    <p class="stats-number text-2xl font-bold">${
                      analyticsData.analytics.totalMessages
                    }</p>
                    <p class="text-sm text-reddit-muted">Total Messages</p>
                  </div>
                </div>
              </div>

              <!-- Items by Type and Status -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="analytics-card rounded-lg p-6">
                  <h4 class="text-lg font-bold mb-4 text-reddit-text">Items by Type</h4>
                  <div class="space-y-3">
                    ${analyticsData.analytics.itemsByType
                      .map(
                        (item) => `
                      <div class="flex items-center justify-between">
                        <span class="text-reddit-text capitalize">${item._id}</span>
                        <span class="stats-number font-bold">${item.count}</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>

                <div class="analytics-card rounded-lg p-6">
                  <h4 class="text-lg font-bold mb-4 text-reddit-text">Items by Status</h4>
                  <div class="space-y-3">
                    ${analyticsData.analytics.itemsByStatus
                      .map(
                        (item) => `
                      <div class="flex items-center justify-between">
                        <span class="text-reddit-text capitalize">${item._id}</span>
                        <span class="stats-number font-bold">${item.count}</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Error loading analytics:", error);
          const container = document.getElementById("tabContent");
          container.innerHTML = `
            <div class="text-center py-20">
              <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-lg border border-red-500 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012  0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-red-500 mb-2">Error Loading Analytics</h3>
              <p class="text-reddit-muted">Please try refreshing the page</p>
            </div>
          `;
        }
      }

      function getStatusClass(status) {
        switch (status) {
          case "active":
            return "status-active";
          case "claimed":
            return "status-claimed";
          default:
            return "status-active";
        }
      }

      // Edit item with validity questions support
      async function editItem(itemId) {
        try {
          showToast("Loading item details...", "info");
          const response = await fetch(`/api/items/${itemId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            const item = data.item;

            document.getElementById("editItemId").value = item._id;
            document.getElementById("editTitle").value = item.title;
            document.getElementById("editDescription").value = item.description;
            document.getElementById("editLocation").value = item.location;

            if (item.type === "found") {
              document
                .getElementById("editValidityQuestionsSection")
                .classList.remove("hidden");
              loadEditValidityQuestions(item.validityQuestions || []);
            } else {
              document
                .getElementById("editValidityQuestionsSection")
                .classList.add("hidden");
            }

            document.getElementById("editItemModal").classList.remove("hidden");
          } else {
            throw new Error("Failed to load item details");
          }
        } catch (error) {
          showToast("Error loading item details. Please try again.", "error");
        }
      }

      function loadEditValidityQuestions(questions) {
        const container = document.getElementById("editValidityQuestionsList");
        editValidityQuestionCount = 0;
        container.innerHTML = "";

        questions.forEach((question, index) => {
          addEditValidityQuestion(question.question, question.answer);
        });

        if (questions.length === 0) {
          addEditValidityQuestion();
        }
      }

      function addEditValidityQuestion(question = "", answer = "") {
        const container = document.getElementById("editValidityQuestionsList");
        const questionDiv = document.createElement("div");
        questionDiv.className = "reddit-card rounded-lg p-4";
        questionDiv.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-reddit-text">Question ${
              editValidityQuestionCount + 1
            }</h4>
            <button type="button" onclick="this.closest('.reddit-card').remove()" class="text-red-400 hover:text-red-300 p-1 rounded">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          <div class="space-y-3">
            <input
              type="text"
              placeholder="Enter verification question"
              value="${question}"
              class="w-full input-field px-3 py-2 rounded-lg text-sm validity-question"
              required
            />
            <input
              type="text"
              placeholder="Enter correct answer"
              value="${answer}"
              class="w-full input-field px-3 py-2 rounded-lg text-sm validity-answer"
              required
            />
          </div>
        `;
        container.appendChild(questionDiv);
        editValidityQuestionCount++;
      }

      document
        .getElementById("editItemForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const itemId = document.getElementById("editItemId").value;
          const formData = new FormData();

          formData.append("title", document.getElementById("editTitle").value);
          formData.append(
            "description",
            document.getElementById("editDescription").value
          );
          formData.append(
            "location",
            document.getElementById("editLocation").value
          );

          const imageFile = document.getElementById("editImage").files[0];
          if (imageFile) {
            formData.append("image", imageFile);
          }

          const validityQuestionsSection = document.getElementById(
            "editValidityQuestionsSection"
          );
          if (!validityQuestionsSection.classList.contains("hidden")) {
            const questions = [];
            const questionInputs =
              document.querySelectorAll(".validity-question");
            const answerInputs = document.querySelectorAll(".validity-answer");

            for (let i = 0; i < questionInputs.length; i++) {
              const question = questionInputs[i].value.trim();
              const answer = answerInputs[i].value.trim();
              if (question && answer) {
                questions.push({ question, answer });
              }
            }

            if (questions.length > 0) {
              formData.append("validityQuestions", JSON.stringify(questions));
            }
          }

          try {
            showToast("Updating item...", "info");
            const response = await fetch(`/api/items/${itemId}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            });

            if (response.ok) {
              hideEditItem();
              showToast("Item updated successfully!", "success");
              switchTab("posted");
            } else {
              throw new Error("Failed to update item");
            }
          } catch (error) {
            showToast("Error updating item. Please try again.", "error");
          }
        });

      // Enhanced view requests with proper question/answer comparison
      async function viewRequests(itemId, type) {
        try {
          showToast("Loading requests...", "info");
          const endpoint =
            type === "claim" ? "claim-requests" : "inform-requests";
          const [requestsResponse, itemResponse] = await Promise.all([
            fetch(`/api/items/${itemId}/${endpoint}`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }),
            fetch(`/api/items/${itemId}`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }),
          ]);

          if (requestsResponse.ok && itemResponse.ok) {
            const requestsData = await requestsResponse.json();
            const itemData = await itemResponse.json();
            const content = document.getElementById("requestsContent");
            const title = document.getElementById("requestsModalTitle");

            title.textContent =
              type === "claim" ? "Claim Requests" : "Inform Requests";
            const requests =
              type === "claim"
                ? requestsData.claimRequests
                : requestsData.informRequests;

            if (requests && requests.length > 0) {
              content.innerHTML = `
                <div class="space-y-6">
                  ${requests
                    .map((request) =>
                      generateRequestCard(request, itemId, type, itemData.item)
                    )
                    .join("")}
                </div>
              `;
            } else {
              content.innerHTML = `
                <div class="text-center py-12">
                  <div class="w-16 h-16 mx-auto mb-4 bg-reddit-border/20 rounded-lg border border-reddit-border flex items-center justify-center">
                    <svg class="w-8 h-8 text-reddit-muted" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <p class="text-reddit-muted text-lg">No ${type} requests yet</p>
                </div>
              `;
            }

            document.getElementById("requestsModal").classList.remove("hidden");
          } else {
            throw new Error("Failed to load requests");
          }
        } catch (error) {
          showToast("Error loading requests. Please try again.", "error");
        }
      }

      // Enhanced request card generation with proper question/answer comparison
      function generateRequestCard(request, itemId, type, item) {
        const userKey = type === "claim" ? "requestedBy" : "informedBy";
        const user = request[userKey];

        return `
          <div class="reddit-card rounded-lg p-6 glow-on-hover">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center space-x-4">
                <div class="user-avatar overflow-hidden">
                  <img src="${getProfileImageUrl(
                    user
                  )}" alt="Profile" class="w-full h-full object-cover" onerror="this.src='${generateProfileInitials(
          user.firstName,
          user.lastName
        )}'">
                </div>
                <div>
                  <h4 class="font-bold text-lg text-reddit-text">${
                    user.firstName
                  } ${user.lastName}</h4>
                  <p class="text-sm text-reddit-muted">${user.department}</p>
                  <p class="text-xs text-reddit-muted mt-1">
                    ${formatTimeAgo(request.createdAt || Date.now())}
                  </p>
                </div>
              </div>
              <span class="status-badge px-4 py-2 text-sm font-bold rounded-lg ${getRequestStatusClass(
                request.status
              )}">${request.status.toUpperCase()}</span>
            </div>

            ${
              type === "claim" &&
              request.answers &&
              request.answers.length > 0 &&
              item.validityQuestions
                ? `
              <div class="mb-6">
                <h5 class="font-semibold mb-3 text-reddit-text flex items-center">
                  <svg class="w-5 h-5 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  Verification Questions & Answers:
                </h5>
                <div class="space-y-4">
                  ${item.validityQuestions
                    .map((validityQ, index) => {
                      const userAnswer =
                        request.answers[index] || "No answer provided";
                      const isCorrect =
                        userAnswer.toLowerCase().trim() ===
                        validityQ.answer.toLowerCase().trim();

                      return `
                      <div class="answer-comparison rounded-lg p-4 ${
                        isCorrect ? "answer-correct" : "answer-incorrect"
                      }">
                        <div class="flex items-start justify-between mb-2">
                          <p class="text-sm font-medium text-blue-400">Question ${
                            index + 1
                          }:</p>
                          <div class="flex items-center space-x-1">
                            <svg class="w-4 h-4 ${
                              isCorrect ? "text-green-400" : "text-red-400"
                            }" fill="currentColor" viewBox="0 0 20 20">
                              ${
                                isCorrect
                                  ? '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>'
                                  : '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>'
                              }
                            </svg>
                            <span class="text-xs font-medium ${
                              isCorrect ? "text-green-400" : "text-red-400"
                            }">
                              ${isCorrect ? "Correct" : "Incorrect"}
                            </span>
                          </div>
                        </div>
                        <p class="text-sm text-reddit-text mb-3">${
                          validityQ.question
                        }</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <p class="text-xs font-medium text-green-400 mb-1">Expected Answer:</p>
                            <p class="text-sm text-reddit-text bg-green-500/10 rounded p-2 border border-green-500/30">${
                              validityQ.answer
                            }</p>
                          </div>
                          <div>
                            <p class="text-xs font-medium text-blue-400 mb-1">User's Answer:</p>
                            <p class="text-sm text-reddit-text bg-blue-500/10 rounded p-2 border border-blue-500/30">${userAnswer}</p>
                          </div>
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
            `
                : ""
            }

            ${
              type === "inform" && request.message
                ? `
              <div class="mb-6">
                <h5 class="font-semibold mb-3 text-reddit-text flex items-center">
                  <svg class="w-5 h-5 mr-2 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"></path>
                  </svg>
                  Finder's Message:
                </h5>
                <div class="bg-reddit-dark/70 rounded-lg p-4 border border-reddit-border/50">
                  <p class="text-sm text-reddit-text leading-relaxed">${request.message}</p>
                </div>
              </div>
            `
                : ""
            }

            ${
              type === "inform" && request.image
                ? `
              <div class="mb-6">
                <h5 class="font-semibold mb-3 text-reddit-text flex items-center">
                  <svg class="w-5 h-5 mr-2 text-reddit-orange" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                  </svg>
                  Found Item Image:
                </h5>
                <div class="relative">
                  <img
                    src="${getFullImageUrl(request.image)}"
                    alt="Found item"
                    class="max-w-full h-64 object-cover cursor-pointer glow-on-hover rounded-lg border border-reddit-orange"
                    onclick="showImageModal('${getFullImageUrl(
                      request.image
                    )}')"
                    onerror="this.parentElement.innerHTML='<div class=\\'w-full h-64 bg-reddit-dark rounded-lg border border-reddit-border flex items-center justify-center\\'>
                      <div class=\\'text-center\\'>
                        <svg class=\\'w-12 h-12 text-reddit-muted mx-auto mb-2\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'>
                          <path fill-rule=\\'evenodd\\' d=\\'M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z\\' clip-rule=\\'evenodd\\'></path>
                        </svg>
                        <p class=\\'text-reddit-muted text-sm\\'>Image not available</p>
                      </div>
                    </div>'"
                  >
                  <div class="absolute top-2 right-2 bg-black/50 text-white px-2 py-1 text-xs rounded">
                    Click to enlarge
                  </div>
                </div>
              </div>
            `
                : ""
            }

            ${
              type === "claim"
                ? request.additionalInfo
                : false
                ? `
              <div class="mb-6">
                <h5 class="font-semibold mb-3 text-reddit-text flex items-center">
                  <svg class="w-5 h-5 mr-2 text-reddit-muted" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                  </svg>
                  Additional Information:
                </h5>
                <div class="bg-reddit-dark/70 rounded-lg p-4 border border-reddit-border/50">
                  <p class="text-sm text-reddit-text leading-relaxed">${request.additionalInfo}</p>
                </div>
              </div>
            `
                : ""
            }

            ${
              request.status === "approved" && request.contactInfo
                ? `
              <div class="contact-info-card rounded-lg p-6 mb-6">
                <h5 class="font-semibold mb-4 text-accent-400 flex items-center text-lg">
                  <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                  </svg>
                  Contact Information Shared
                </h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  ${
                    request.contactInfo.phone
                      ? `<div class="flex items-center space-x-2">
                           <svg class="w-4 h-4 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                             <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                           </svg>
                           <span class="font-medium">Phone:</span>
                           <span class="text-accent-400">${request.contactInfo.phone}</span>
                         </div>`
                      : ""
                  }
                  ${
                    request.contactInfo.alternatePhone
                      ? `<div class="flex items-center space-x-2">
                           <svg class="w-4 h-4 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                             <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                           </svg>
                           <span class="font-medium">Alt Phone:</span>
                           <span class="text-accent-400">${request.contactInfo.alternatePhone}</span>
                         </div>`
                      : ""
                  }
                  ${
                    request.contactInfo.email
                      ? `<div class="flex items-center space-x-2">
                           <svg class="w-4 h-4 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                             <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                           </svg>
                           <span class="font-medium">Email:</span>
                           <span class="text-accent-400">${request.contactInfo.email}</span>
                         </div>`
                      : ""
                  }
                  ${
                    request.contactInfo.meetingLocation
                      ? `<div class="flex items-center space-x-2">
                           <svg class="w-4 h-4 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                             <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                           </svg>
                           <span class="font-medium">Location:</span>
                           <span class="text-reddit-text">${request.contactInfo.meetingLocation}</span>
                         </div>`
                      : ""
                  }
                  ${
                    request.contactInfo.meetingTime
                      ? `<div class="flex items-center space-x-2">
                           <svg class="w-4 h-4 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                             <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                           </svg>
                           <span class="font-medium">Time:</span>
                           <span class="text-reddit-text">${request.contactInfo.meetingTime}</span>
                         </div>`
                      : ""
                  }
                  ${
                    request.contactInfo.additionalNotes
                      ? `<div class="md:col-span-2 mt-2">
                           <div class="flex items-start space-x-2">
                             <svg class="w-4 h-4 text-accent-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                               <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                             </svg>
                             <div>
                               <span class="font-medium block">Additional Notes:</span>
                               <span class="text-reddit-text">${request.contactInfo.additionalNotes}</span>
                             </div>
                           </div>
                         </div>`
                      : ""
                  }
                </div>
              </div>
            `
                : ""
            }

            ${
              request.status === "rejected" && request.rejectionReason
                ? `
              <div class="bg-red-500/10 rounded-lg border border-red-500/30 p-4 mb-6">
                <h5 class="font-semibold mb-2 text-red-400 flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                  </svg>
                  Rejection Reason:
                </h5>
                <p class="text-sm text-red-300">${request.rejectionReason}</p>
              </div>
            `
                : ""
            }

            ${
              request.status === "pending"
                ? `
              <div class="flex gap-4 mt-6">
                <button onclick="showContactInfo('${itemId}', '${request._id}', '${type}')" class="flex-1 btn-primary py-3 rounded-lg text-sm font-semibold">
                  Approve Request
                </button>
                <button onclick="showRejectionModal('${itemId}', '${request._id}', '${type}')" class="flex-1 btn-danger py-3 rounded-lg text-sm font-semibold">
                  Reject Request
                </button>
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function showImageModal(imageSrc) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4";
        modal.innerHTML = `
          <div class="relative max-w-4xl max-h-[90vh] w-full">
            <button
              onclick="this.closest('.modal-backdrop').remove()"
              class="absolute top-4 right-4 z-10 bg-black/50 text-white p-2 hover:bg-black/70 rounded-lg transition-all duration-200"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <img
              src="${imageSrc}"
              alt="Full size image"
              class="w-full h-full object-contain shadow-2xl rounded-lg border border-reddit-orange"
            >
          </div>
        `;
        document.body.appendChild(modal);
      }

      function getRequestStatusClass(status) {
        switch (status) {
          case "pending":
            return "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30";
          case "approved":
            return "status-found";
          case "rejected":
            return "bg-red-500/20 text-red-400 border border-red-500/30";
          default:
            return "bg-gray-500/20 text-gray-400 border border-gray-500/30";
        }
      }

      function showContactInfo(itemId, requestId, type) {
        pendingApproval = { itemId, requestId, type };
        document.getElementById("contactInfoModal").classList.remove("hidden");
        document.getElementById("contactPhone").focus();
      }

      function hideContactInfo() {
        document.getElementById("contactInfoModal").classList.add("hidden");
        document.getElementById("contactInfoForm").reset();
        pendingApproval = null;
      }

      document
        .getElementById("contactInfoForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!pendingApproval) return;

          const contactInfo = {
            phone: document.getElementById("contactPhone").value.trim(),
            alternatePhone: document
              .getElementById("contactAlternatePhone")
              .value.trim(),
            email: document.getElementById("contactEmail").value.trim(),
            meetingLocation: document
              .getElementById("contactLocation")
              .value.trim(),
            meetingTime: document.getElementById("contactTime").value.trim(),
            additionalNotes: document
              .getElementById("contactNotes")
              .value.trim(),
          };

          if (!contactInfo.phone) {
            showToast("Phone number is required", "warning");
            return;
          }

          try {
            showToast("Approving request...", "info");
            const endpoint =
              pendingApproval.type === "claim"
                ? "claim-requests"
                : "inform-requests";
            const response = await fetch(
              `/api/items/${pendingApproval.itemId}/${endpoint}/${pendingApproval.requestId}/approve`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ contactInfo }),
              }
            );

            if (response.ok) {
              hideContactInfo();
              showToast("Request approved successfully!", "success");
              hideRequests();
              switchTab("posted");
            } else {
              throw new Error("Failed to approve request");
            }
          } catch (error) {
            showToast("Error approving request. Please try again.", "error");
          }
        });

      async function viewContactInfo(itemId) {
        try {
          showToast("Loading contact information...", "info");
          const response = await fetch(`/api/items/${itemId}/contact-info`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            const contactInfo = data.contactInfo;

            const modal = document.createElement("div");
            modal.className =
              "fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4";
            modal.innerHTML = `
              <div class="reddit-card rounded-lg max-w-lg w-full p-8 shadow-2xl animate-scale-in">
                <h3 class="text-2xl font-bold mb-6 gradient-text">
                  Contact Information
                </h3>
                <div class="contact-info-card rounded-lg p-6 mb-6">
                  <div class="space-y-4">
                    ${
                      contactInfo.phone
                        ? `<div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Phone</p>
                               <p class="text-accent-400 font-semibold">${contactInfo.phone}</p>
                             </div>
                           </div>`
                        : ""
                    }
                    ${
                      contactInfo.alternatePhone
                        ? `<div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Alternate Phone</p>
                               <p class="text-accent-400 font-semibold">${contactInfo.alternatePhone}</p>
                             </div>
                           </div>`
                        : ""
                    }
                    ${
                      contactInfo.email
                        ? `<div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Email</p>
                               <p class="text-accent-400 font-semibold">${contactInfo.email}</p>
                             </div>
                           </div>`
                        : ""
                    }
                    ${
                      contactInfo.meetingLocation
                        ? `<div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Meeting Location</p>
                               <p class="text-reddit-text">${contactInfo.meetingLocation}</p>
                             </div>
                           </div>`
                        : ""
                    }
                    ${
                      contactInfo.meetingTime
                        ? `<div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Meeting Time</p>
                               <p class="text-reddit-text">${contactInfo.meetingTime}</p>
                             </div>
                           </div>`
                        : ""
                    }
                    ${
                      contactInfo.additionalNotes
                        ? `<div class="flex items-start space-x-3">
                             <div class="w-10 h-10 bg-accent-500/20 rounded-lg border border-accent-500 flex items-center justify-center">
                               <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                                 <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                               </svg>
                             </div>
                             <div>
                               <p class="font-medium text-reddit-text">Additional Notes</p>
                               <p class="text-reddit-text">${contactInfo.additionalNotes}</p>
                             </div>
                           </div>`
                        : ""
                    }
                  </div>
                </div>
                <button onclick="this.closest('.modal-backdrop').remove()" class="w-full btn-primary py-3 rounded-lg font-semibold">
                  Close
                </button>
              </div>
            `;
            document.body.appendChild(modal);
          } else {
            throw new Error("Failed to load contact information");
          }
        } catch (error) {
          showToast(
            "Error loading contact information. Please try again.",
            "error"
          );
        }
      }

      function showRejectionModal(itemId, requestId, type) {
        pendingRejection = { itemId, requestId, type };
        document.getElementById("rejectionModal").classList.remove("hidden");
        document.getElementById("rejectionReason").focus();
      }

      function hideRejectionModal() {
        document.getElementById("rejectionModal").classList.add("hidden");
        document.getElementById("rejectionReason").value = "";
        pendingRejection = null;
      }

      async function submitRejection() {
        const reason = document.getElementById("rejectionReason").value.trim();
        if (!reason) {
          showToast("Please provide a reason for rejection", "warning");
          return;
        }

        if (!pendingRejection) return;

        try {
          showToast("Rejecting request...", "info");
          const endpoint =
            pendingRejection.type === "claim"
              ? "claim-requests"
              : "inform-requests";
          const response = await fetch(
            `/api/items/${pendingRejection.itemId}/${endpoint}/${pendingRejection.requestId}/reject`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ rejectionReason: reason }),
            }
          );

          if (response.ok) {
            hideRejectionModal();
            showToast("Request rejected successfully!", "success");
            hideRequests();
            switchTab("posted");
          } else {
            throw new Error("Failed to reject request");
          }
        } catch (error) {
          showToast("Error rejecting request. Please try again.", "error");
        }
      }

      function confirmBlockUser(userId, userName) {
        if (userId === currentUser._id) {
          showToast("You cannot block yourself", "warning");
          return;
        }

        pendingBlock = userId;
        document.getElementById(
          "blockUserMessage"
        ).textContent = `Are you sure you want to block ${userName}? They will no longer be able to claim your items or contact you.`;
        document.getElementById("confirmBlockButton").onclick = () => {
          blockUser(userId);
          hideBlockUser();
        };
        document.getElementById("blockUserModal").classList.remove("hidden");
      }

      async function blockUser(userId) {
        try {
          showToast("Blocking user...", "info");
          const response = await fetch(`/api/users/${userId}/block`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            showToast("User blocked successfully!", "success");
            switchTab("messages");
          } else {
            throw new Error("Failed to block user");
          }
        } catch (error) {
          showToast("Error blocking user. Please try again.", "error");
        }
      }

      function hideBlockUser() {
        document.getElementById("blockUserModal").classList.add("hidden");
        pendingBlock = null;
      }

      function confirmDelete(type, id, name) {
        deleteCallback = () => {
          switch (type) {
            case "item":
              deleteItem(id);
              break;
            case "comment":
              deleteComment(id);
              break;
            case "suggestion":
              deleteSuggestion(id);
              break;
          }
        };

        document.getElementById(
          "deleteConfirmMessage"
        ).textContent = `Are you sure you want to delete ${name}? This action cannot be undone.`;
        document.getElementById("confirmDeleteButton").onclick = () => {
          if (deleteCallback) deleteCallback();
          hideDeleteConfirm();
        };
        document
          .getElementById("deleteConfirmModal")
          .classList.remove("hidden");
      }

      async function deleteItem(itemId) {
        try {
          showToast("Deleting item...", "info");
          const response = await fetch(`/api/items/${itemId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            showToast("Item deleted successfully!", "success");
            switchTab("posted");
          } else {
            throw new Error("Failed to delete item");
          }
        } catch (error) {
          showToast("Error deleting item. Please try again.", "error");
        }
      }

      function editComment(commentId, content) {
        editingType = "comment";
        editingId = commentId;
        document.getElementById("editModalTitle").textContent = "Edit Comment";
        document.getElementById("editContent").value = content;
        document.getElementById("editModal").classList.remove("hidden");
      }

      function editSuggestion(suggestionId, content) {
        editingType = "suggestion";
        editingId = suggestionId;
        document.getElementById("editModalTitle").textContent =
          "Edit Suggestion";
        document.getElementById("editContent").value = content;
        document.getElementById("editModal").classList.remove("hidden");
      }

      async function saveEdit() {
        const content = document.getElementById("editContent").value.trim();
        if (!content) {
          showToast("Content cannot be empty", "warning");
          return;
        }

        try {
          showToast(`Updating ${editingType}...`, "info");
          const endpoint =
            editingType === "comment"
              ? `/api/comments/${editingId}`
              : `/api/suggestions/${editingId}`;
          const response = await fetch(endpoint, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ content }),
          });

          if (response.ok) {
            hideEditModal();
            showToast(
              `${
                editingType === "comment" ? "Comment" : "Suggestion"
              } updated successfully!`,
              "success"
            );
            switchTab(editingType === "comment" ? "comments" : "suggestions");
          } else {
            throw new Error(`Failed to update ${editingType}`);
          }
        } catch (error) {
          showToast(
            `Error updating ${editingType}. Please try again.`,
            "error"
          );
        }
      }

      async function deleteComment(commentId) {
        try {
          showToast("Deleting comment...", "info");
          const response = await fetch(`/api/comments/${commentId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            showToast("Comment deleted successfully!", "success");
            switchTab("comments");
          } else {
            throw new Error("Failed to delete comment");
          }
        } catch (error) {
          showToast("Error deleting comment. Please try again.", "error");
        }
      }

      async function deleteSuggestion(suggestionId) {
        try {
          showToast("Deleting suggestion...", "info");
          const response = await fetch(`/api/suggestions/${suggestionId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            showToast("Suggestion deleted successfully!", "success");
            switchTab("suggestions");
          } else {
            throw new Error("Failed to delete suggestion");
          }
        } catch (error) {
          showToast("Error deleting suggestion. Please try again.", "error");
        }
      }

      // Modal functions
      function showUpdateProfile() {
        document
          .getElementById("updateProfileModal")
          .classList.remove("hidden");
      }

      function hideUpdateProfile() {
        document.getElementById("updateProfileModal").classList.add("hidden");
      }

      function hideEditItem() {
        document.getElementById("editItemModal").classList.add("hidden");
      }

      function hideRequests() {
        document.getElementById("requestsModal").classList.add("hidden");
      }

      function hideEditModal() {
        document.getElementById("editModal").classList.add("hidden");
        editingType = null;
        editingId = null;
      }

      function hideDeleteConfirm() {
        document.getElementById("deleteConfirmModal").classList.add("hidden");
        deleteCallback = null;
      }

      function goHome() {
        window.location.href = "home.html";
      }

      function postItem() {
        window.location.href = "post-item.html";
      }

      function logout() {
        if (notificationPollingInterval) {
          clearInterval(notificationPollingInterval);
        }

        localStorage.removeItem("token");
        showToast("Logged out successfully", "success");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1000);
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toastDiv = document.createElement("div");

        const colors = {
          success: "bg-gradient-to-r from-accent-500 to-green-500",
          error: "bg-gradient-to-r from-red-500 to-red-600",
          warning: "bg-gradient-to-r from-yellow-500 to-yellow-600",
          info: "bg-gradient-to-r from-reddit-orange to-reddit-upvote",
        };

        const icons = {
          success: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
          error: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`,
          warning: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`,
          info: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`,
        };

        toastDiv.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl transform transition-all duration-300 flex items-center space-x-3 max-w-md animate-slide-down border border-white/20`;
        toastDiv.innerHTML = `
          ${icons[type]}
          <span class="font-medium">${message}</span>
        `;

        container.appendChild(toastDiv);

        setTimeout(() => {
          toastDiv.style.transform = "translateX(120%)";
          setTimeout(() => {
            if (container.contains(toastDiv)) {
              container.removeChild(toastDiv);
            }
          }, 300);
        }, 4000);
      }

      window.addEventListener("beforeunload", () => {
        if (notificationPollingInterval) {
          clearInterval(notificationPollingInterval);
        }
      });
    </script>
  </body>
</html>
